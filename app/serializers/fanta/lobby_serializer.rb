require File.expand_path('../../../../config/environment', __FILE__) if $0 == __FILE__

module Fanta
  class LobbySerializer < ApplicationSerializer
    def id
    end

    has_many :battles, serializer: BattleEachSerializer do
      Fanta::Battle.st_battle_now.latest_list
    end

    has_many :lobby_messages do
      Fanta::LobbyMessage.latest_list.reverse
    end

    has_many :online_users, serializer: OnlineUserSerializer do
      Fanta::User.online_only.order(online_at: :desc)
    end
  end

  if $0 == __FILE__
    pp ams_sr({}, serializer: LobbySerializer, include: {battles: {memberships: :user}, lobby_messages: :user, online_users: {active_battles: nil}})
  end
end
# >> I, [2018-07-02T18:47:02.248721 #19876]  INFO -- : Rendered Fanta::LobbySerializer with ActiveModelSerializers::Adapter::Attributes (2318.97ms)
# >> {:id=>nil,
# >>  :battles=>
# >>   [{:id=>71,
# >>     :name=>"#71",
# >>     :show_path=>"/online/battles/71",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>241,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>50,
# >>          :name=>"CPU8号",
# >>          :show_path=>"/online/users/50",
# >>          :avatar_url=>
# >>           "/assets/robot/0110_robot-e704feafb4d5b9c5bdc19e6e70d310f7bccafa00f22cdb9e32f7c8cdc321b71a.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>242,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>49,
# >>          :name=>"CPU7号",
# >>          :show_path=>"/online/users/49",
# >>          :avatar_url=>
# >>           "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>72,
# >>     :name=>"#72",
# >>     :show_path=>"/online/battles/72",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>243,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>50,
# >>          :name=>"CPU8号",
# >>          :show_path=>"/online/users/50",
# >>          :avatar_url=>
# >>           "/assets/robot/0110_robot-e704feafb4d5b9c5bdc19e6e70d310f7bccafa00f22cdb9e32f7c8cdc321b71a.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>244,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>49,
# >>          :name=>"CPU7号",
# >>          :show_path=>"/online/users/49",
# >>          :avatar_url=>
# >>           "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>69,
# >>     :name=>"#69",
# >>     :show_path=>"/online/battles/69",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>237,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>48,
# >>          :name=>"CPU6号",
# >>          :show_path=>"/online/users/48",
# >>          :avatar_url=>
# >>           "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>238,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>47,
# >>          :name=>"CPU5号",
# >>          :show_path=>"/online/users/47",
# >>          :avatar_url=>
# >>           "/assets/robot/0150_robot-619f7c7c4831fffd861716e3c76fe47c8605b2a036522a89d2635078b20bc213.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>70,
# >>     :name=>"#70",
# >>     :show_path=>"/online/battles/70",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>239,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>48,
# >>          :name=>"CPU6号",
# >>          :show_path=>"/online/users/48",
# >>          :avatar_url=>
# >>           "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>240,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>47,
# >>          :name=>"CPU5号",
# >>          :show_path=>"/online/users/47",
# >>          :avatar_url=>
# >>           "/assets/robot/0150_robot-619f7c7c4831fffd861716e3c76fe47c8605b2a036522a89d2635078b20bc213.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>67,
# >>     :name=>"#67",
# >>     :show_path=>"/online/battles/67",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>233,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>46,
# >>          :name=>"CPU4号",
# >>          :show_path=>"/online/users/46",
# >>          :avatar_url=>
# >>           "/assets/robot/0100_robot-66c73ea6ee9d1d87bad3f3b22739b74cbe9bdba17b06e9f65a8f7f63b6fb2467.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>234,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>45,
# >>          :name=>"CPU3号",
# >>          :show_path=>"/online/users/45",
# >>          :avatar_url=>
# >>           "/assets/robot/0120_robot-da4aa855dd2b8d97caf50f6c9a2155fc19e8fea5252c86a38f23c864a743f2b1.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>68,
# >>     :name=>"#68",
# >>     :show_path=>"/online/battles/68",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>235,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>46,
# >>          :name=>"CPU4号",
# >>          :show_path=>"/online/users/46",
# >>          :avatar_url=>
# >>           "/assets/robot/0100_robot-66c73ea6ee9d1d87bad3f3b22739b74cbe9bdba17b06e9f65a8f7f63b6fb2467.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>236,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>45,
# >>          :name=>"CPU3号",
# >>          :show_path=>"/online/users/45",
# >>          :avatar_url=>
# >>           "/assets/robot/0120_robot-da4aa855dd2b8d97caf50f6c9a2155fc19e8fea5252c86a38f23c864a743f2b1.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>65,
# >>     :name=>"#65",
# >>     :show_path=>"/online/battles/65",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>229,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>43,
# >>          :name=>"CPU2号",
# >>          :show_path=>"/online/users/43",
# >>          :avatar_url=>
# >>           "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>230,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>42,
# >>          :name=>"CPU1号",
# >>          :show_path=>"/online/users/42",
# >>          :avatar_url=>
# >>           "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>66,
# >>     :name=>"#66",
# >>     :show_path=>"/online/battles/66",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>
# >>      [{:id=>231,
# >>        :location_key=>"black",
# >>        :user=>
# >>         {:id=>43,
# >>          :name=>"CPU2号",
# >>          :show_path=>"/online/users/43",
# >>          :avatar_url=>
# >>           "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>          :race_key=>"robot"}},
# >>       {:id=>232,
# >>        :location_key=>"white",
# >>        :user=>
# >>         {:id=>42,
# >>          :name=>"CPU1号",
# >>          :show_path=>"/online/users/42",
# >>          :avatar_url=>
# >>           "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>          :race_key=>"robot"}}]},
# >>    {:id=>63,
# >>     :name=>"#63",
# >>     :show_path=>"/online/battles/63",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>64,
# >>     :name=>"#64",
# >>     :show_path=>"/online/battles/64",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>62,
# >>     :name=>"#62",
# >>     :show_path=>"/online/battles/62",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>61,
# >>     :name=>"#61",
# >>     :show_path=>"/online/battles/61",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>59,
# >>     :name=>"#59",
# >>     :show_path=>"/online/battles/59",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>60,
# >>     :name=>"#60",
# >>     :show_path=>"/online/battles/60",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>58,
# >>     :name=>"#58",
# >>     :show_path=>"/online/battles/58",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>57,
# >>     :name=>"#57",
# >>     :show_path=>"/online/battles/57",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>56,
# >>     :name=>"#56",
# >>     :show_path=>"/online/battles/56",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>55,
# >>     :name=>"#55",
# >>     :show_path=>"/online/battles/55",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>54,
# >>     :name=>"#54",
# >>     :show_path=>"/online/battles/54",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>53,
# >>     :name=>"#53",
# >>     :show_path=>"/online/battles/53",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]},
# >>    {:id=>52,
# >>     :name=>"#52",
# >>     :show_path=>"/online/battles/52",
# >>     :xstate_info=>
# >>      #<Fanta::XstateInfo:0x00007f99493a41b8
# >>       @attributes=
# >>        {:key=>:st_battle_now,
# >>         :name=>"対局中",
# >>         :color=>"has-text-danger",
# >>         :code=>1}>,
# >>     :turn_max=>0,
# >>     :watch_ships_count=>0,
# >>     :memberships=>[]}],
# >>  :lobby_messages=>[],
# >>  :online_users=>
# >>   [{:id=>44,
# >>     :name=>"野良1号",
# >>     :show_path=>"/online/users/44",
# >>     :avatar_url=>
# >>      "/assets/human/0021_fallback_avatar_icon-35f7d2753708660f1028e234d7214edb783933bb8b41335c3cf9c1ba3bc171f2.png",
# >>     :race_key=>"human",
# >>     :fighting_at=>nil,
# >>     :matching_at=>nil,
# >>     :active_battles=>[]},
# >>    {:id=>50,
# >>     :name=>"CPU8号",
# >>     :show_path=>"/online/users/50",
# >>     :avatar_url=>
# >>      "/assets/robot/0110_robot-e704feafb4d5b9c5bdc19e6e70d310f7bccafa00f22cdb9e32f7c8cdc321b71a.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:46:21 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>71, :name=>"#71", :show_path=>"/online/battles/71"},
# >>       {:id=>72, :name=>"#72", :show_path=>"/online/battles/72"}]},
# >>    {:id=>49,
# >>     :name=>"CPU7号",
# >>     :show_path=>"/online/users/49",
# >>     :avatar_url=>
# >>      "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:46:21 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>71, :name=>"#71", :show_path=>"/online/battles/71"},
# >>       {:id=>72, :name=>"#72", :show_path=>"/online/battles/72"}]},
# >>    {:id=>48,
# >>     :name=>"CPU6号",
# >>     :show_path=>"/online/users/48",
# >>     :avatar_url=>
# >>      "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:44:59 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>69, :name=>"#69", :show_path=>"/online/battles/69"},
# >>       {:id=>70, :name=>"#70", :show_path=>"/online/battles/70"}]},
# >>    {:id=>47,
# >>     :name=>"CPU5号",
# >>     :show_path=>"/online/users/47",
# >>     :avatar_url=>
# >>      "/assets/robot/0150_robot-619f7c7c4831fffd861716e3c76fe47c8605b2a036522a89d2635078b20bc213.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:44:59 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>69, :name=>"#69", :show_path=>"/online/battles/69"},
# >>       {:id=>70, :name=>"#70", :show_path=>"/online/battles/70"}]},
# >>    {:id=>46,
# >>     :name=>"CPU4号",
# >>     :show_path=>"/online/users/46",
# >>     :avatar_url=>
# >>      "/assets/robot/0100_robot-66c73ea6ee9d1d87bad3f3b22739b74cbe9bdba17b06e9f65a8f7f63b6fb2467.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:37:02 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>67, :name=>"#67", :show_path=>"/online/battles/67"},
# >>       {:id=>68, :name=>"#68", :show_path=>"/online/battles/68"}]},
# >>    {:id=>45,
# >>     :name=>"CPU3号",
# >>     :show_path=>"/online/users/45",
# >>     :avatar_url=>
# >>      "/assets/robot/0120_robot-da4aa855dd2b8d97caf50f6c9a2155fc19e8fea5252c86a38f23c864a743f2b1.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:37:02 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>67, :name=>"#67", :show_path=>"/online/battles/67"},
# >>       {:id=>68, :name=>"#68", :show_path=>"/online/battles/68"}]},
# >>    {:id=>43,
# >>     :name=>"CPU2号",
# >>     :show_path=>"/online/users/43",
# >>     :avatar_url=>
# >>      "/assets/robot/0140_robot-31e558f84b967f63efd70bcfd54af2398ab701b0102470e503d349192dbb35da.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:33:31 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>65, :name=>"#65", :show_path=>"/online/battles/65"},
# >>       {:id=>66, :name=>"#66", :show_path=>"/online/battles/66"}]},
# >>    {:id=>42,
# >>     :name=>"CPU1号",
# >>     :show_path=>"/online/users/42",
# >>     :avatar_url=>
# >>      "/assets/robot/0130_robot-fd50cb547420b0fd51a8f0c0e2c101d0ea25c5b93e47f66a3dd5e71c5ba51b62.png",
# >>     :race_key=>"robot",
# >>     :fighting_at=>Mon, 02 Jul 2018 18:33:31 JST +09:00,
# >>     :matching_at=>nil,
# >>     :active_battles=>
# >>      [{:id=>65, :name=>"#65", :show_path=>"/online/battles/65"},
# >>       {:id=>66, :name=>"#66", :show_path=>"/online/battles/66"}]}]}
