require "./setup"

user = User.sysop
# user.wkbk_articles.destroy_all
# user.wkbk_books.destroy_all

book_title = "寄せの手筋200"
if book = user.wkbk_books.find_by(title: book_title)
  book.articles.destroy_all
  book.destroy
end

dir = Rails.root.join("kifu_data").expand_path
dir.glob("#{book_title}/*.kif").sort.take(500).each do |file|
  str = file.read.strip
  next if str.empty?

  puts file
  # /Users/ikeda/src/shogi-extend/ysntsj/01460_107_2_△13銀の変化.kif

  info = Bioshogi::Parser.parse(str)
  str = info.to_sfen                    # => "position sfen 7k1/9/9/9/9/9/9/9/9 b GSN2r2b3g3s3n4l18p 1 moves S*2c G*2b N*3c 2a1a G*2a 2b2a 3c2a+ 1a2a G*2b", "position sfen 4k4/9/9/3Bp4/9/9/9/9/9 b G2N2rb3g4s2n4l18p 1 moves 6d5c+ S*5b N*4c 5b4c N*6c 5a4a G*4b", "position sfen 4k4/9/3S5/9/9/9/9/9/9 b 2S2r2b4gs4n4l18p 1 moves S*4c R*1b S*5b 1b5b 6c5b+", "position sfen 6k2/9/5p2p/9/9/9/9/9/9 b GSP2b2s 1 moves S*3c S*2c P*3b 2c3b G*4b 3a2a 4b3b 2a1b 3b2b", "position sfen 4k4/9/3ppp3/9/9/9/9/9/9 b GSNP 1 moves N*5d 5c5d S*5c N*5b P*4b 5a6a G*6b", "position sfen 5ksnl/9/4Sp1p1/6p1p/9/9/9/9/9 b 2SN2r2b4g2n3l14p 1 moves N*4d 4c4d S*4c R*9b S*5b 9b5b 5c5b+", "position sfen 7nl/6k2/4pp3/6pRp/5P3/9/9/9/9 b GSr2b3g3s3n3l13p 1 moves 2d2a+ 3b2a S*2c G*3b N*3c 2a3a G*4a", "position sfen l8/2k6/2n1p4/pppp5/9/9/9/9/9 b BGS 1 moves B*8a 7b8a S*8c 8a7a G*7b", "position sfen 5+R1nl/6gk1/9/5ppPp/9/9/9/9/9 b Gr2b2g4s3n3l14p 1 moves G*2c 3b2c 4a2a 2b2a 2d2c+ G*3b N*3c 2a3a G*4a", "position sfen 7nl/7g1/5B1kP/8p/7p1/9/9/9/9 b GS2rb2g3s3n3l15p 1 moves G*3d 2c1c S*2d 1c1b 3d2c 2b2c 4c2a+ 1b2a 2d2c+ G*2b N*3c 2a3a G*4a", "position sfen ln1g+R4/1sk6/pppp5/4pp3/9/9/9/9/9 b S2Nr2b3g2sn3l12p 1 moves N*6d 6c6d 5a6a 7b6a S*6c B*5c G*5b 6a7a 5b5c R*1b B*6b 7a6a 5c5b 1b5b N*5c 5b5c 6b5c+ R*1b R*6b 6a5a 6b5b+ 1b5b 6c5b+", "position sfen 3R3nl/4g1ks1/4pp1p1/6p1p/4B4/5P2P/6PP1/9/9 b GNrb2g3s2n3l9p 1 moves N*2d 2c2d 5e2b+ 3b2b 6a2a+ 2b2a S*2c R*4b N*3c 2a3a G*2a", "position sfen ln7/k1+P6/1pp6/p8/9/9/9/9/+p8 b 2B2r4g4s3n3l12p 1 moves B*7a S*9c B*8b S*8d 8b9c+ 8d9c S*8b 9i8i 8b8a", "position sfen lnB6/k1s6/1pp6/p8/1+b7/9/9/9/+p8 b G2N2r3g3sn3l13p 1 moves N*7d 7c7d N*8d 8c8d G*8b 9b9c 8b7b 9c8c 7a8b+", "position sfen ln7/1k7/1ppS5/p8/9/9/9/9/9 b BG2rb3g3s3n3l15p 1 moves B*7a 8b9b 6c7b+", "position sfen ln7/1k7/1ppS5/p8/9/9/9/9/9 b BG2rb3g3s3n3l15p 1 moves B*7a 8b9b G*9c 8a9c 6c7b+ L*8a 7b8a 9b8a L*8b 8a7a", "position sfen ln7/2k6/1ppp+B4/p1b6/9/9/9/9/+p8 b 2G2r2g4s3n3l12p 1 moves G*6a 7b8b 5c7a 8b9b G*7b S*9c 7a8a", "position sfen 1n7/2k6/1p2+B4/2p6/r8/9/9/9/+p8 b 2Grb2g4s3n4l14p 1 moves G*6c 7b8b 5c7a 8b9b G*9a 9b9a 6c7b 9e9b 7a8a", "position sfen ln1g5/2k6/1ppp+B4/p8/2P6/9/9/9/+p8 b GSN2rb2g3s2n3l12p 1 moves S*7a 6a7a N*6d 6c6d G*6c 7b8b 5c7a 8b9b 6c7b", "position sfen ln1g5/2k6/1ppp+B4/p8/9/9/9/9/+p8 b GSN2rb2g3s2n3l13p 1 moves G*7a 7b8b 7a6a R*7b S*7a 8b9b G*8b 7b8b 7a8b 9i8i 8b8a 9b9c 5c7e 8c8d N*8e 9c8c 8e7c+ 8c7c R*7b 7c8c 7e7d 8c9c 7b7c+", "position sfen ln1g5/2k6/1ppp+B4/p8/9/9/9/9/+p8 b GSN2rb2g3s2n3l13p 1 moves G*7a 7b8b 7a6a R*7b S*7a 8b9b G*8b 7b8b 7a8b 9i8i 8b8a 9b9c 5c7e 8c8d N*8e 9c8c 8e7c+ 8c7c R*7b 7c8c 7e7d 8c9c 7b7c+"

  sfen = Bioshogi::Sfen.parse(str)
  init_sfen = sfen.board_and_b_or_w_and_piece_box_and_turn # => "7k1/9/9/9/9/9/9/9/9 b GSN2r2b3g3s3n4l18p 1", "4k4/9/9/3Bp4/9/9/9/9/9 b G2N2rb3g4s2n4l18p 1", "4k4/9/3S5/9/9/9/9/9/9 b 2S2r2b4gs4n4l18p 1", "6k2/9/5p2p/9/9/9/9/9/9 b GSP2b2s 1", "4k4/9/3ppp3/9/9/9/9/9/9 b GSNP 1", "5ksnl/9/4Sp1p1/6p1p/9/9/9/9/9 b 2SN2r2b4g2n3l14p 1", "7nl/6k2/4pp3/6pRp/5P3/9/9/9/9 b GSr2b3g3s3n3l13p 1", "l8/2k6/2n1p4/pppp5/9/9/9/9/9 b BGS 1", "5+R1nl/6gk1/9/5ppPp/9/9/9/9/9 b Gr2b2g4s3n3l14p 1", "7nl/7g1/5B1kP/8p/7p1/9/9/9/9 b GS2rb2g3s3n3l15p 1", "ln1g+R4/1sk6/pppp5/4pp3/9/9/9/9/9 b S2Nr2b3g2sn3l12p 1", "3R3nl/4g1ks1/4pp1p1/6p1p/4B4/5P2P/6PP1/9/9 b GNrb2g3s2n3l9p 1", "ln7/k1+P6/1pp6/p8/9/9/9/9/+p8 b 2B2r4g4s3n3l12p 1", "lnB6/k1s6/1pp6/p8/1+b7/9/9/9/+p8 b G2N2r3g3sn3l13p 1", "ln7/1k7/1ppS5/p8/9/9/9/9/9 b BG2rb3g3s3n3l15p 1", "ln7/1k7/1ppS5/p8/9/9/9/9/9 b BG2rb3g3s3n3l15p 1", "ln7/2k6/1ppp+B4/p1b6/9/9/9/9/+p8 b 2G2r2g4s3n3l12p 1", "1n7/2k6/1p2+B4/2p6/r8/9/9/9/+p8 b 2Grb2g4s3n4l14p 1", "ln1g5/2k6/1ppp+B4/p8/2P6/9/9/9/+p8 b GSN2rb2g3s2n3l12p 1", "ln1g5/2k6/1ppp+B4/p8/9/9/9/9/+p8 b GSN2rb2g3s2n3l13p 1", "ln1g5/2k6/1ppp+B4/p8/9/9/9/9/+p8 b GSN2rb2g3s2n3l13p 1"
  sfen.moves                                   # => ["S*2c", "G*2b", "N*3c", "2a1a", "G*2a", "2b2a", "3c2a+", "1a2a", "G*2b"], ["6d5c+", "S*5b", "N*4c", "5b4c", "N*6c", "5a4a", "G*4b"], ["S*4c", "R*1b", "S*5b", "1b5b", "6c5b+"], ["S*3c", "S*2c", "P*3b", "2c3b", "G*4b", "3a2a", "4b3b", "2a1b", "3b2b"], ["N*5d", "5c5d", "S*5c", "N*5b", "P*4b", "5a6a", "G*6b"], ["N*4d", "4c4d", "S*4c", "R*9b", "S*5b", "9b5b", "5c5b+"], ["2d2a+", "3b2a", "S*2c", "G*3b", "N*3c", "2a3a", "G*4a"], ["B*8a", "7b8a", "S*8c", "8a7a", "G*7b"], ["G*2c", "3b2c", "4a2a", "2b2a", "2d2c+", "G*3b", "N*3c", "2a3a", "G*4a"], ["G*3d", "2c1c", "S*2d", "1c1b", "3d2c", "2b2c", "4c2a+", "1b2a", "2d2c+", "G*2b", "N*3c", "2a3a", "G*4a"], ["N*6d", "6c6d", "5a6a", "7b6a", "S*6c", "B*5c", "G*5b", "6a7a", "5b5c", "R*1b", "B*6b", "7a6a", "5c5b", "1b5b", "N*5c", "5b5c", "6b5c+", "R*1b", "R*6b", "6a5a", "6b5b+", "1b5b", "6c5b+"], ["N*2d", "2c2d", "5e2b+", "3b2b", "6a2a+", "2b2a", "S*2c", "R*4b", "N*3c", "2a3a", "G*2a"], ["B*7a", "S*9c", "B*8b", "S*8d", "8b9c+", "8d9c", "S*8b", "9i8i", "8b8a"], ["N*7d", "7c7d", "N*8d", "8c8d", "G*8b", "9b9c", "8b7b", "9c8c", "7a8b+"], ["B*7a", "8b9b", "6c7b+"], ["B*7a", "8b9b", "G*9c", "8a9c", "6c7b+", "L*8a", "7b8a", "9b8a", "L*8b", "8a7a"], ["G*6a", "7b8b", "5c7a", "8b9b", "G*7b", "S*9c", "7a8a"], ["G*6c", "7b8b", "5c7a", "8b9b", "G*9a", "9b9a", "6c7b", "9e9b", "7a8a"], ["S*7a", "6a7a", "N*6d", "6c6d", "G*6c", "7b8b", "5c7a", "8b9b", "6c7b"], ["G*7a", "7b8b", "7a6a", "R*7b", "S*7a", "8b9b", "G*8b", "7b8b", "7a8b", "9i8i", "8b8a", "9b9c", "5c7e", "8c8d", "N*8e", "9c8c", "8e7c+", "8c7c", "R*7b", "7c8c", "7e7d", "8c9c", "7b7c+"], ["G*7a", "7b8b", "7a6a", "R*7b", "S*7a", "8b9b", "G*8b", "7b8b", "7a8b", "9i8i", "8b8a", "9b9c", "5c7e", "8c8d", "N*8e", "9c8c", "8e7c+", "8c7c", "R*7b", "7c8c", "7e7d", "8c9c", "7b7c+"]

  parts = file.basename(".kif").to_s.split("_")   # => ["001", "1"], ["002", "1"], ["003", "1"], ["004", "1"], ["005", "1"], ["006", "1"], ["007", "1"], ["008", "1"], ["010", "1"], ["011", "1"], ["012", "1"], ["013", "1"], ["037", "1"], ["038", "1"], ["039", "1"], ["039", "2", "先に▲93金だと△81香で失敗"], ["043", "1"], ["044", "1"], ["045", "1"], ["046", "1"], ["046", "2", "▲71銀で失敗する変化"]
  title = "寄せの手筋" + parts[0]                 # => "寄せの手筋001", "寄せの手筋002", "寄せの手筋003", "寄せの手筋004", "寄せの手筋005", "寄せの手筋006", "寄せの手筋007", "寄せの手筋008", "寄せの手筋010", "寄せの手筋011", "寄せの手筋012", "寄せの手筋013", "寄せの手筋037", "寄せの手筋038", "寄せの手筋039", "寄せの手筋039", "寄せの手筋043", "寄せの手筋044", "寄せの手筋045", "寄せの手筋046", "寄せの手筋046"
  sub_title = parts[2]                            # => nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil, "先に▲93金だと△81香で失敗", nil, nil, nil, nil, "▲71銀で失敗する変化"

  article = user.wkbk_articles.find_or_initialize_by(title: title)
  article.lineage_key = "手筋"
  article.title = title
  article.init_sfen = sfen.board_and_b_or_w_and_piece_box_and_turn
  article.folder_key = :private
  article.save!                    # => true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true
  article.moves_answers.create!(moves_str: sfen.moves.join(" ")) # => #<Wkbk::MovesAnswer id: 186, article_id: 113, moves_count: 9, moves_str: "S*2c G*2b N*3c 2a1a G*2a 2b2a 3c2a+ 1a2a G*2b", moves_human_str: "▲23銀打 △22金打 ▲33桂打 △11玉 ▲21金打 △同金 ▲同桂成 △同玉 ▲22金打", position: 0, created_at: "2021-02-10 01:47:43", updated_at: "2021-02-10 01:47:43">, #<Wkbk::MovesAnswer id: 187, article_id: 114, moves_count: 7, moves_str: "6d5c+ S*5b N*4c 5b4c N*6c 5a4a G*4b", moves_human_str: "▲53角成 △52銀打 ▲43桂打 △同銀 ▲63桂打 △41玉 ▲42金打", position: 0, created_at: "2021-02-10 01:47:43", updated_at: "2021-02-10 01:47:43">, #<Wkbk::MovesAnswer id: 188, article_id: 115, moves_count: 5, moves_str: "S*4c R*1b S*5b 1b5b 6c5b+", moves_human_str: "▲43銀打 △12飛打 ▲52銀打 △同飛 ▲同銀左成", position: 0, created_at: "2021-02-10 01:47:43", updated_at: "2021-02-10 01:47:43">, #<Wkbk::MovesAnswer id: 189, article_id: 116, moves_count: 9, moves_str: "S*3c S*2c P*3b 2c3b G*4b 3a2a 4b3b 2a1b 3b2b", moves_human_str: "▲33銀打 △23銀打 ▲32歩打 △同銀 ▲42金打 △21玉 ▲32金 △12玉 ▲22金", position: 0, created_at: "2021-02-10 01:47:43", updated_at: "2021-02-10 01:47:43">, #<Wkbk::MovesAnswer id: 190, article_id: 117, moves_count: 7, moves_str: "N*5d 5c5d S*5c N*5b P*4b 5a6a G*6b", moves_human_str: "▲54桂打 △同歩 ▲53銀打 △52桂打 ▲42歩打 △61玉 ▲62金打", position: 0, created_at: "2021-02-10 01:47:43", updated_at: "2021-02-10 01:47:43">, #<Wkbk::MovesAnswer id: 191, article_id: 118, moves_count: 7, moves_str: "N*4d 4c4d S*4c R*9b S*5b 9b5b 5c5b+", moves_human_str: "▲44桂打 △同歩 ▲43銀打 △92飛打 ▲52銀打 △同飛 ▲同銀直成", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 192, article_id: 119, moves_count: 7, moves_str: "2d2a+ 3b2a S*2c G*3b N*3c 2a3a G*4a", moves_human_str: "▲21飛成 △同玉 ▲23銀打 △32金打 ▲33桂打 △31玉 ▲41金打", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 193, article_id: 120, moves_count: 5, moves_str: "B*8a 7b8a S*8c 8a7a G*7b", moves_human_str: "▲81角打 △同玉 ▲83銀打 △71玉 ▲72金打", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 194, article_id: 121, moves_count: 9, moves_str: "G*2c 3b2c 4a2a 2b2a 2d2c+ G*3b N*3c 2a3a G*4a", moves_human_str: "▲23金打 △同金 ▲21龍 △同玉 ▲23歩成 △32金打 ▲33桂打 △31玉 ▲41金打", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 195, article_id: 122, moves_count: 13, moves_str: "G*3d 2c1c S*2d 1c1b 3d2c 2b2c 4c2a+ 1b2a 2d2c+ G*2...", moves_human_str: "▲34金打 △13玉 ▲24銀打 △12玉 ▲23金 △同金 ▲21角成 △同玉 ▲23銀成 △22...", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 196, article_id: 123, moves_count: 23, moves_str: "N*6d 6c6d 5a6a 7b6a S*6c B*5c G*5b 6a7a 5b5c R*1b ...", moves_human_str: "▲64桂打 △同歩 ▲61龍 △同玉 ▲63銀打 △53角打 ▲52金打 △71玉 ▲53金 △12...", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 197, article_id: 124, moves_count: 11, moves_str: "N*2d 2c2d 5e2b+ 3b2b 6a2a+ 2b2a S*2c R*4b N*3c 2a3...", moves_human_str: "▲24桂打 △同歩 ▲22角成 △同玉 ▲21飛成 △同玉 ▲23銀打 △42飛打 ▲33桂打 △3...", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 198, article_id: 125, moves_count: 9, moves_str: "B*7a S*9c B*8b S*8d 8b9c+ 8d9c S*8b 9i8i 8b8a", moves_human_str: "▲71角打 △93銀打 ▲82角打 △84銀打 ▲93角成 △同銀 ▲82銀打 △89と ▲81銀不...", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 199, article_id: 126, moves_count: 9, moves_str: "N*7d 7c7d N*8d 8c8d G*8b 9b9c 8b7b 9c8c 7a8b+", moves_human_str: "▲74桂打 △同歩 ▲84桂打 △同歩 ▲82金打 △93玉 ▲72金 △83玉 ▲82角成", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 200, article_id: 127, moves_count: 3, moves_str: "B*7a 8b9b 6c7b+", moves_human_str: "▲71角打 △92玉 ▲72銀成", position: 0, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 201, article_id: 127, moves_count: 10, moves_str: "B*7a 8b9b G*9c 8a9c 6c7b+ L*8a 7b8a 9b8a L*8b 8a7a", moves_human_str: "▲71角打 △92玉 ▲93金打 △同桂 ▲72銀成 △81香打 ▲同成銀 △同玉 ▲82香打 △7...", position: 1, created_at: "2021-02-10 01:47:44", updated_at: "2021-02-10 01:47:44">, #<Wkbk::MovesAnswer id: 202, article_id: 128, moves_count: 7, moves_str: "G*6a 7b8b 5c7a 8b9b G*7b S*9c 7a8a", moves_human_str: "▲61金打 △82玉 ▲71馬 △92玉 ▲72金打 △93銀打 ▲81馬", position: 0, created_at: "2021-02-10 01:47:45", updated_at: "2021-02-10 01:47:45">, #<Wkbk::MovesAnswer id: 203, article_id: 129, moves_count: 9, moves_str: "G*6c 7b8b 5c7a 8b9b G*9a 9b9a 6c7b 9e9b 7a8a", moves_human_str: "▲63金打 △82玉 ▲71馬 △92玉 ▲91金打 △同玉 ▲72金 △92飛 ▲81馬", position: 0, created_at: "2021-02-10 01:47:45", updated_at: "2021-02-10 01:47:45">, #<Wkbk::MovesAnswer id: 204, article_id: 130, moves_count: 9, moves_str: "S*7a 6a7a N*6d 6c6d G*6c 7b8b 5c7a 8b9b 6c7b", moves_human_str: "▲71銀打 △同金 ▲64桂打 △同歩 ▲63金打 △82玉 ▲71馬 △92玉 ▲72金", position: 0, created_at: "2021-02-10 01:47:45", updated_at: "2021-02-10 01:47:45">, #<Wkbk::MovesAnswer id: 205, article_id: 131, moves_count: 23, moves_str: "G*7a 7b8b 7a6a R*7b S*7a 8b9b G*8b 7b8b 7a8b 9i8i ...", moves_human_str: "▲71金打 △82玉 ▲61金 △72飛打 ▲71銀打 △92玉 ▲82金打 △同飛 ▲同銀不成 △...", position: 0, created_at: "2021-02-10 01:47:45", updated_at: "2021-02-10 01:47:45">

  book = user.wkbk_books.find_or_initialize_by(title: book_title)
  book.folder_key = :private
  book.articles << article
  book.save!                      # => true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true, true
end
