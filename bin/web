#!/usr/bin/env ruby
#
# web
# web -e production
#

require "bundler/setup"
Dir.chdir(Bundler.root)

require "thor"
require "webdrivers"
require "capybara/dsl"
require "pathname"

BASIC_AUTH = eval(Pathname(".basic_auth.rb").read)
VALIDATE_URLS = eval(Pathname("VALIDATE_URLS").read)

Capybara.current_driver = :selenium_chrome

class Web < Thor
  package_name "web"
  default_command :validate
  class_option :env, type: :string, desc: "対象の環境", default: "staging", aliases: "-e"

  desc "validate", "表示確認"
  def validate
    if options[:env] == "staging"
      app_host = "https://#{BASIC_AUTH[:user]}:#{BASIC_AUTH[:password]}@shogi-flow.xyz"
    else
      app_host = "https://www.shogi-extend.com"
    end
    Capybara.app_host = app_host

    VALIDATE_URLS.each do |url|
      window = Capybara.open_new_window
      Capybara.switch_to_window(window)
      path = URI(url).request_uri
      Capybara.visit(path)
    end

    $stdin.gets
  end

  start
end
