#!/usr/bin/env ruby
#
# OGP自動テスト
#
# ogp
# ogp -e production

URESINORYU = "body=position%20sfen%20lnsgkgsnl%2F1r5b1%2Fppppppppp%2F9%2F9%2F9%2FPPPPPPPPP%2F1B5R1%2FLNSGKGSNL%20b%20-%201%20moves%207i6h&turn=1&title=%E5%AC%89%E9%87%8E%E6%B5%81&abstract_viewpoint=self"

LIST_ALL = [
  { url: "/users/1",                                                                 validations: { "title" => /さん/,                                                                                                                                      }},

  { url: "/settings/profile",                                                        validations: { "error" => "404"                                                                                                                                      }},
  { url: "/settings/email",                                                          validations: { "error" => "404",                                                                                                                                      }},

  { url: "/",                                                                        validations: { "title" => "SHOGI-EXTEND(d)",                                                                                                           }},
  { url: "/swars/search?query=Yamada_Taro",                                          validations: { "title" => /Yamada_Taro/,                                                                                                                                       }},
  { url: "/swars/users/Yamada_Taro/",                                                validations: { "og:title" => /Yamada_Taro/,                                                                                                                                                                }},
  { url: "/swars/battles/devuser3-Yamada_Taro-20200101_123403/",                     validations: { "og:image" => /Yamada_Taro.*png.*turn/                                                                                                                                                                }},
  { url: "/swars/battles/devuser3-Yamada_Taro-20200101_123403/?turn=100&viewpoint=black", validations: { "og:image" => /Yamada_Taro.*png.*turn=100/,                                                                                                                                                                }},
  { url: "/swars/battles/devuser3-Yamada_Taro-20200101_123403/formal-sheet",         validations: { "og:title" => /Yamada_Taro/,                                                                                                                                                                }},
  { url: "/swars/users/Yamada_Taro/direct-open/kento",                               validations: { "title" => /KENTO/, "mombile_icon" => /kento/,                                                                                                                          }},
  { url: "/swars/users/Yamada_Taro/direct-open/piyo_shogi",                          validations: { "title" => /ぴよ/,  "mombile_icon" => /piyo_shogi/,                                                                                                                     }},
  { url: "/swars/users/Yamada_Taro/kento-api",                                       validations: { "title" => /Yamada_Taro/,                                                                                                                                       }},
  { url: "/swars/histograms/attack",                                                 validations: { "title" => /戦型/,                                                                                                                                              }},
  { url: "/swars/histograms/grade",                                                  validations: { "title" => /段級/,                                                                                                                                              }},
  { url: "/swars/top-group",                                                         validations: { "title" => /上位/,                                                                                                                                              }},
  { url: "/swars/professional",                                                      validations: { "title" => /十段/,                                                                                                                                              }},
  { url: "/xy",                                                                      validations: { "title" => /符号の鬼/,                                                                                                                                          }},
  { url: "/vs-clock",                                                                validations: { "title" => /対局時計/,                                                                                                                                          }},
  { url: "/three-stage-leagues",                                                     validations: { "og:title" => /第\d+期.*奨励会三段リーグ/,                                                                                                                                                                }},
  { url: "/three-stage-leagues/67",                                                  validations: { "og:title" => /第67期.*奨励会三段リーグ/,                                                                                                                                             }},
  { url: "/three-stage-league-players/%E4%BC%8A%E8%97%A4%E5%8C%A0",                  validations: { "og:title" => /伊藤匠の成績/,                                                                                                                                                                }},
  { url: "/adapter",                                                                 validations: { "title" => /なんでも棋譜変換/,                                                                                                                                  }},
  { url: "/share-board",                                                             validations: { "title" => "共有将棋盤 0手目", "og:title" => "共有将棋盤 0手目", "og:description" => "",                     "og:image" => /share-board.png.*position.*turn=0/, }},
  { url: "/share-board?#{URESINORYU}",                                               validations: { "title" => "嬉野流 1手目",     "og:title" => "嬉野流 1手目",     "og:description" => "☗嬉野流 vs ☖その他", "og:image" => /share-board.png.*position.*turn=1/,   }},
  { url: "/stopwatch",                                                               validations: { "title" => /ストップウォッチ/,                                                                                                                                  }},
  { url: "/cpu-battle",                                                              validations: { "title" => /対戦/,                                                                                                                                              }},
  { url: "/training",                                                                validations: { "title" => /トレーニング/,                                                                                                                                      }},
  { url: "/style-editor",                                                            validations: { "title" => /スタイルエディタ/,                                                                                                                                   }},
  { url: "/practical-checkmate",                                                     validations: { "title" => /実戦詰将棋/,                                                                                                                                   }},
  { url: "/blindfold",                                                               validations: { "title" => /目隠し詰将棋/,                                                                                                                                   }},
]

require "bundler/setup"
Dir.chdir(Bundler.root)

require "thor"
require "pathname"
require "open-uri"
require "nokogiri"
require "table_format"

class Ogp < Thor
  package_name "ogp"
  default_command :validate
  class_option :env,   type: :string,  desc: "対象環境", default: "development", aliases: "-e"
  class_option :debug, type: :boolean, desc: "デバッグ", default: false,         aliases: "-d"

  desc "validate", "確認"
  def validate
    puts "(#{options[:env]})"

    rows = LIST_ALL.collect do |e|
      {
        "結果" => "？",
        "画像" => "",
      }.tap do |row|
        url = e[:url]
        unless url.start_with?("http")
          url = host + e[:url]
        end
        puts url

        row["URL"] = url
        begin
          html = URI(url).read
        rescue OpenURI::HTTPError => error
          row["結果"] = error.to_s.include?(e[:validations]["error"]) ? "○" : "×"
          next
        end
        doc = Nokogiri::HTML(html)

        if options[:debug]
          tp doc.search("meta")
        end

        attributes = [
          "og:image",
          "og:title",
          "og:description",
          "twitter:card",
        ].inject({}) {|a, k|
          content = nil
          if element = doc.at("meta[property='#{k}']")
            content = element[:content]
          else
            raise "タグが見つからない : #{k}"
          end
          a.merge(k => content)
        }
        attributes["title"] = doc.title
        attributes["mombile_icon"] = doc.at("link[rel=apple-touch-icon]")[:href]

        # row["title"]    = attributes["title"]
        row["og:title"] = attributes["og:title"]

        row.update(attributes)

        all = attributes.merge("html" => html)

        validations = e[:validations]
        if !validations.empty?
          good = validations.all? { |key, s|
            if s.kind_of?(String)
              s = /\A#{Regexp.escape(s)}\z/
            end
            all[key].match?(s)
          }
          row["結果"] = good ? "○" : "×"
        end

        bin = URI(attributes["og:image"]).read rescue ""
        row["画像"] = bin[1..3] == "PNG" ? "○" : "×"
      end
    end
    tp rows
  end

  private

  def host
    {
      :development => "http://localhost:4000",
      :staging     => "https://shogi-flow.xyz",
      :production  => "https://www.shogi-extend.com",
    }.fetch(options[:env].to_sym)
  end

  start
end
# ~> -:76:in `include?': no implicit conversion of nil into String (TypeError)
# ~> 	from -:76:in `rescue in block (2 levels) in validate'
# ~> 	from -:73:in `block (2 levels) in validate'
# ~> 	from -:65:in `tap'
# ~> 	from -:65:in `block in validate'
# ~> 	from -:61:in `collect'
# ~> 	from -:61:in `validate'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/command.rb:27:in `run'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/invocation.rb:127:in `invoke_command'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor.rb:392:in `dispatch'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/base.rb:485:in `start'
# ~> 	from -:137:in `<class:Ogp>'
# ~> 	from -:51:in `<main>'
# ~> /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:378:in `open_http': 404 Not Found (OpenURI::HTTPError)
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:756:in `buffer_open'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:226:in `block in open_loop'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:224:in `catch'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:224:in `open_loop'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:165:in `open_uri'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:736:in `open'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/2.6.0/open-uri.rb:744:in `read'
# ~> 	from -:74:in `block (2 levels) in validate'
# ~> 	from -:65:in `tap'
# ~> 	from -:65:in `block in validate'
# ~> 	from -:61:in `collect'
# ~> 	from -:61:in `validate'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/command.rb:27:in `run'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/invocation.rb:127:in `invoke_command'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor.rb:392:in `dispatch'
# ~> 	from /usr/local/var/rbenv/versions/2.6.5/lib/ruby/gems/2.6.0/gems/thor-1.0.1/lib/thor/base.rb:485:in `start'
# ~> 	from -:137:in `<class:Ogp>'
# ~> 	from -:51:in `<main>'
# >> (development)
# >> http://localhost:4000/users/1
# >> http://localhost:4000/settings/profile
# >> http://localhost:4000/settings/email
# >> http://localhost:4000/
# >> http://localhost:4000/swars/search?query=Yamada_Taro
# >> http://localhost:4000/swars/users/Yamada_Taro/
# >> http://localhost:4000/swars/battles/devuser3-Yamada_Taro-20200101_123403/
# >> http://localhost:4000/swars/battles/devuser3-Yamada_Taro-20200101_123403/?turn=100&viewpoint=black
# >> http://localhost:4000/swars/battles/devuser3-Yamada_Taro-20200101_123403/formal-sheet
# >> http://localhost:4000/swars/users/Yamada_Taro/direct-open/kento
# >> http://localhost:4000/swars/users/Yamada_Taro/direct-open/piyo_shogi
# >> http://localhost:4000/swars/users/Yamada_Taro/kento-api
# >> http://localhost:4000/swars/histograms/attack
# >> http://localhost:4000/swars/histograms/grade
# >> http://localhost:4000/swars/top-group
# >> http://localhost:4000/swars/professional
# >> http://localhost:4000/xy
# >> http://localhost:4000/vs-clock
# >> http://localhost:4000/three-stage-leagues
# >> http://localhost:4000/three-stage-leagues/67
# >> http://localhost:4000/three-stage-league-players/%E4%BC%8A%E8%97%A4%E5%8C%A0
# >> http://localhost:4000/adapter
# >> http://localhost:4000/share-board
# >> http://localhost:4000/share-board?body=position%20sfen%20lnsgkgsnl%2F1r5b1%2Fppppppppp%2F9%2F9%2F9%2FPPPPPPPPP%2F1B5R1%2FLNSGKGSNL%20b%20-%201%20moves%207i6h&turn=1&title=%E5%AC%89%E9%87%8E%E6%B5%81&abstract_viewpoint=self
# >> http://localhost:4000/stopwatch
# >> http://localhost:4000/cpu-battle
# >> http://localhost:4000/actb
