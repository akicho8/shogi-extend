#!/usr/bin/env ruby
#
# ogp
# ogp -e production

require "bundler/setup"
Dir.chdir(Bundler.root)

require "thor"
require "pathname"
require "open-uri"
require "nokogiri"
require "table_format"

URESINORYU = "body=position%20sfen%20lnsgkgsnl%2F1r5b1%2Fppppppppp%2F9%2F9%2F9%2FPPPPPPPPP%2F1B5R1%2FLNSGKGSNL%20b%20-%201%20moves%207i6h&turn=1&title=%E5%AC%89%E9%87%8E%E6%B5%81&image_view_point=self"

class Ogp < Thor
  package_name "ogp"
  default_command :validate
  class_option :env,   type: :string,  desc: "対象環境", default: "development", aliases: "-e"

  desc "validate", "確認"
  def validate
    puts "(#{options[:env]})"

    # url = host + URI(url).request_uri
    rows = [
      # { url: "/",                                                                :validations => { "html"  => /電脳少女シロ/, "title" => "SHOGI-EXTEND",                                                                       }},
      # { url: "/swars/battles?query=Yamada_Taro",                                 :validations => { "title" => /Yamada_Taro/,                                                                                                  }},
      # { url: "/swars/users/Yamada_Taro/",                                        :validations => {                                                                                                                            }},
      # { url: "/swars/battles/devuser3-Yamada_Taro-20200101_123403/",             :validations => {                                                                                                                            }},
      # { url: "/swars/battles/devuser3-Yamada_Taro-20200101_123403/formal-sheet", :validations => {                                                                                                                            }},
      # { url: "/swars/users/Yamada_Taro/direct-open/kento",                       :validations => { "title" => /KENTO/, "icon" => /kento/,                                                                                         }},
      # { url: "/swars/users/Yamada_Taro/direct-open/piyo_shogi",                  :validations => { "title" => /ぴよ/,  "icon" => /piyo_shogi/,                                                                                    }},
      # { url: "/swars/users/Yamada_Taro/kento-api",                               :validations => { "title" => /Yamada_Taro/,                                                                                                  }},
      # { url: "/swars/histograms/attack",                                         :validations => { "title" => /戦型/,                                                                                                         }},
      # { url: "/swars/histograms/grade",                                          :validations => { "title" => /段級/,                                                                                                         }},
      # { url: "/swars/top-group",                                                 :validations => { "title" => /上位/,                                                                                                         }},
      # { url: "/swars/professional",                                              :validations => { "title" => /十段/,                                                                                                         }},
      # { url: "/xy",                                                              :validations => { "title" => /符号の鬼/,                                                                                                     }},
      # { url: "/vs-clock",                                                        :validations => { "title" => /対局時計/,                                                                                                     }},
      # { url: "/three-stage-leagues",                                             :validations => {                                                                                                                            }},
      # { url: "/three-stage-leagues/67",                                          :validations => { "html"  => /伊藤匠/,                                                                                                            }},
      # { url: "/three-stage-league-players/%E4%BC%8A%E8%97%A4%E5%8C%A0",          :validations => {                                                                                                                            }},
      # { url: "/adapter",                                                         :validations => { "title" => /なんでも棋譜変換/,                                                                                             }},
      { url: "/share-board",                                                     :validations => { "title" => "共有将棋盤 0手目", "og:title" => "共有将棋盤 0手目", "og:description" => "",                     "og:image" => /share-board.png.*position.*turn=0/, }},
      { url: "/share-board?#{URESINORYU}",                                       :validations => { "title" => "嬉野流 1手目",     "og:title" => "嬉野流 1手目",     "og:description" => "☗嬉野流 vs ☖その他", "og:image" => /share-board.png.*position.*turn=1/, }},
    ].collect do |e|
      {
        "結果" => "",
        "画像" => "",
      }.tap do |row|
        url = e[:url]
        unless url.start_with?("http")
          url = host + e[:url]
        end
        puts url

        row["URL"] = url
        html = URI(url).read
        doc = Nokogiri::HTML(html)

        # p doc.title
        # puts doc.search("meta")

        attributes = [
          "og:image",
          "og:title",
          "og:description",
          "twitter:card",
        ].inject({}) {|a, k|
          content = nil
          if element = doc.at("meta[property='#{k}']")
            content = element[:content]
          else
            raise "タグが見つからない : #{k}"
          end
          a.merge(k => content)
        }
        attributes["title"] = doc.title
        attributes["icon"] = doc.at("link[rel=apple-touch-icon]")[:href]

        # row["title"]    = attributes["title"]
        row["og:title"] = attributes["og:title"]

        row.update(attributes)

        all = attributes.merge("html" => html)

        validations = e[:validations]
        good = validations.all? { |key, s|
          if s.kind_of?(String)
            s = /\A#{Regexp.escape(s)}\z/
          end
          all[key].match?(s)
        }
        row["結果"] = good ? "○" : "×"

        bin = URI(attributes["og:image"]).read rescue ""
        row["画像"] = bin[1..3] == "PNG" ? "○" : "×"
      end
    end
    tp rows
  end

  private

  def host
    {
      :development => "http://localhost:4000",
      :staging     => "https://shogi-flow.xyz",
      :production  => "https://www.shogi-extend.com",
    }.fetch(options[:env].to_sym)
  end

  start
end
# >> (development)
# >> http://localhost:4000/share-board
# >> http://localhost:4000/share-board?body=position%20sfen%20lnsgkgsnl%2F1r5b1%2Fppppppppp%2F9%2F9%2F9%2FPPPPPPPPP%2F1B5R1%2FLNSGKGSNL%20b%20-%201%20moves%207i6h&turn=1&title=%E5%AC%89%E9%87%8E%E6%B5%81&image_view_point=self
# >> |------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------+----------------------+---------------------+------------------+-----------------------|
# >> | 結果 | 画像 | URL                                                                                                                                                                                                                          | og:title         | og:image                                                                                                                                    | og:description       | twitter:card        | title            | icon                  |
# >> |------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------+----------------------+---------------------+------------------+-----------------------|
# >> | ○   | ○   | http://localhost:4000/share-board                                                                                                                                                                                            | 共有将棋盤 0手目 | http://0.0.0.0:3000/share-board.png?body=position+startpos&image_view_point=self&title=%E5%85%B1%E6%9C%89%E5%B0%86%E6%A3%8B%E7%9B%A4&turn=0 |                      | summary_large_image | 共有将棋盤 0手目 | /apple-touch-icon.png |
# >> | ○   | ○   | http://localhost:4000/share-board?body=position%20sfen%20lnsgkgsnl%2F1r5b1%2Fppppppppp%2F9%2F9%2F9%2FPPPPPPPPP%2F1B5R1%2FLNSGKGSNL%20b%20-%201%20moves%207i6h&turn=1&title=%E5%AC%89%E9%87%8E%E6%B5%81&image_view_point=self | 嬉野流 1手目     | http://0.0.0.0:3000/share-board.png?body=position+startpos+moves+7i6h&image_view_point=self&title=%E5%AC%89%E9%87%8E%E6%B5%81&turn=1        | ☗嬉野流 vs ☖その他 | summary_large_image | 嬉野流 1手目     | /apple-touch-icon.png |
# >> |------+------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------+---------------------------------------------------------------------------------------------------------------------------------------------+----------------------+---------------------+------------------+-----------------------|
