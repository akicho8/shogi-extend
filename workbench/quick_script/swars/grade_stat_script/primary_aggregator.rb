require "./setup"
scope = Swars::Membership.where(id: Swars::Membership.last(200).collect(&:id))
_ { QuickScript::Swars::GradeStatScript::PrimaryAggregator.new(scope: scope).call } # => "80.81 ms"
s { QuickScript::Swars::GradeStatScript::PrimaryAggregator.new(scope: scope).call } # => {"三段"=>{"__tag_nothing__"=>1, "高美濃囲い"=>1, "振り飛車"=>1, "大駒コンプリート"=>1, "対居飛車"=>1, "対抗形"=>1, "持久戦"=>1, "長手数"=>1, "割り打ちの銀"=>1}, "四段"=>{"__tag_nothing__"=>1, "対振り持久戦"=>1, "舟囲い"=>1, "居飛車"=>1, "対振り飛車"=>1, "大駒全ブッチ"=>1, "対抗形"=>1, "持久戦"=>1, "長手数"=>1}}
# >>   Swars::Membership Count (1.8ms)  SELECT COUNT(*) AS `count_all`, `swars_grades`.`key` AS `swars_grades_key` FROM `swars_memberships` INNER JOIN `swars_grades` ON `swars_grades`.`id` = `swars_memberships`.`grade_id` WHERE `swars_memberships`.`id` IN (100028905, 100028906, 100028907, 100028908, 100028909, 100028910, 100028911, 100028912, 100028913, 100028914, 100028927, 100028928, 100028929, 100028930, 100028931, 100028932, 100028933, 100028934, 100028935, 100028936, 100028937, 100028938, 100028939, 100028940, 100028941, 100028942, 100028943, 100028944, 100028945, 100028946, 100028947, 100028948, 100028949, 100028950, 100028951, 100028952, 100028953, 100028954, 100028958, 100028959, 100028960, 100028961, 100028962, 100028963, 100028964, 100028965, 100028966, 100028967, 100028968, 100028969, 100028970, 100028971, 100028972, 100028973, 100028974, 100028975, 100028976, 100028977, 100028978, 100028979, 100028980, 100028981, 100028982, 100028983, 100028984, 100028985, 100028986, 100028987, 100028988, 100028989, 100028990, 100028991, 100028992, 100028993, 100028994, 100028995, 100028996, 100028997, 100028998, 100028999, 100029000, 100029001, 100029002, 100029003, 100029004, 100029005, 100029006, 100029007, 100029008, 100029009, 100029010, 100029011, 100029012, 100029013, 100029014, 100029015, 100029016, 100029017, 100029018, 100029019, 100029020, 100029021, 100029022, 100029023, 100029024, 100029025, 100029026, 100029027, 100029028, 100029029, 100029030, 100029031, 100029032, 100029033, 100029034, 100029035, 100029036, 100029037, 100029038, 100029039, 100029040, 100029041, 100029042, 100029043, 100029044, 100029045, 100029046, 100029047, 100029048, 100029049, 100029050, 100029051, 100029052, 100029053, 100029054, 100029055, 100029056, 100029057, 100029058, 100029059, 100029060, 100029061, 100029062, 100029063, 100029064, 100029065, 100029066, 100029067, 100029068, 100029069, 100029070, 100029071, 100029072, 100029073, 100029074, 100029075, 100029076, 100029077, 100029078, 100029079, 100029080, 100029081, 100029082, 100029083, 100029084, 100029085, 100029086, 100029087, 100029088, 100029089, 100029090, 100029091, 100029092, 100029093, 100029094, 100029095, 100029096, 100029097, 100029098, 100029099, 100029100, 100029101, 100029102, 100029103, 100029104, 100029105, 100029106, 100029107, 100029108, 100029109, 100029110, 100029111, 100029112, 100029113, 100029114, 100029115, 100029116, 100029117, 100029118, 100029119) AND `swars_memberships`.`grade_id` IN (SELECT `swars_grades`.`id` FROM `swars_grades` WHERE `swars_grades`.`key` IN ('九段', '八段', '七段', '六段', '五段', '四段', '三段', '二段', '初段', '1級', '2級', '3級', '4級', '5級', '6級', '7級', '8級', '9級', '10級')) GROUP BY `swars_grades`.`key`
# >>   ↳ app/models/quick_script/swars/grade_stat_script/primary_aggregator.rb:12:in `call'
# >>   Swars::Membership Count (2.2ms)  SELECT COUNT(*) AS `count_all`, `swars_grades`.`key` AS `swars_grades_key`, `tags`.`name` AS `tags_name` FROM `swars_memberships` INNER JOIN `swars_grades` ON `swars_grades`.`id` = `swars_memberships`.`grade_id` INNER JOIN `taggings` ON `taggings`.`taggable_type` = 'Swars::Membership' AND `taggings`.`taggable_id` = `swars_memberships`.`id` INNER JOIN `tags` ON `tags`.`id` = `taggings`.`tag_id` WHERE `swars_memberships`.`id` IN (100028905, 100028906, 100028907, 100028908, 100028909, 100028910, 100028911, 100028912, 100028913, 100028914, 100028927, 100028928, 100028929, 100028930, 100028931, 100028932, 100028933, 100028934, 100028935, 100028936, 100028937, 100028938, 100028939, 100028940, 100028941, 100028942, 100028943, 100028944, 100028945, 100028946, 100028947, 100028948, 100028949, 100028950, 100028951, 100028952, 100028953, 100028954, 100028958, 100028959, 100028960, 100028961, 100028962, 100028963, 100028964, 100028965, 100028966, 100028967, 100028968, 100028969, 100028970, 100028971, 100028972, 100028973, 100028974, 100028975, 100028976, 100028977, 100028978, 100028979, 100028980, 100028981, 100028982, 100028983, 100028984, 100028985, 100028986, 100028987, 100028988, 100028989, 100028990, 100028991, 100028992, 100028993, 100028994, 100028995, 100028996, 100028997, 100028998, 100028999, 100029000, 100029001, 100029002, 100029003, 100029004, 100029005, 100029006, 100029007, 100029008, 100029009, 100029010, 100029011, 100029012, 100029013, 100029014, 100029015, 100029016, 100029017, 100029018, 100029019, 100029020, 100029021, 100029022, 100029023, 100029024, 100029025, 100029026, 100029027, 100029028, 100029029, 100029030, 100029031, 100029032, 100029033, 100029034, 100029035, 100029036, 100029037, 100029038, 100029039, 100029040, 100029041, 100029042, 100029043, 100029044, 100029045, 100029046, 100029047, 100029048, 100029049, 100029050, 100029051, 100029052, 100029053, 100029054, 100029055, 100029056, 100029057, 100029058, 100029059, 100029060, 100029061, 100029062, 100029063, 100029064, 100029065, 100029066, 100029067, 100029068, 100029069, 100029070, 100029071, 100029072, 100029073, 100029074, 100029075, 100029076, 100029077, 100029078, 100029079, 100029080, 100029081, 100029082, 100029083, 100029084, 100029085, 100029086, 100029087, 100029088, 100029089, 100029090, 100029091, 100029092, 100029093, 100029094, 100029095, 100029096, 100029097, 100029098, 100029099, 100029100, 100029101, 100029102, 100029103, 100029104, 100029105, 100029106, 100029107, 100029108, 100029109, 100029110, 100029111, 100029112, 100029113, 100029114, 100029115, 100029116, 100029117, 100029118, 100029119) AND `swars_memberships`.`grade_id` IN (SELECT `swars_grades`.`id` FROM `swars_grades` WHERE `swars_grades`.`key` IN ('九段', '八段', '七段', '六段', '五段', '四段', '三段', '二段', '初段', '1級', '2級', '3級', '4級', '5級', '6級', '7級', '8級', '9級', '10級')) GROUP BY `swars_grades`.`key`, `tags`.`name`
# >>   ↳ app/models/quick_script/swars/grade_stat_script/primary_aggregator.rb:21:in `call'
