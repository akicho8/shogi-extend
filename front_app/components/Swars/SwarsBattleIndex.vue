<template lang="pug">
.SwarsBattleIndex
  | ğŸ‘‹ğŸ» ğŸ¤šğŸ» ğŸ–ğŸ» âœ‹ğŸ» ğŸ––ğŸ» ğŸ‘ŒğŸ» ğŸ¤ğŸ» âœŒğŸ» ğŸ¤ğŸ» ğŸ¤ŸğŸ» ğŸ¤˜ğŸ» ğŸ¤™ğŸ» ğŸ‘ˆğŸ» ğŸ‘‰ğŸ» ğŸ‘†ğŸ» ğŸ–•ğŸ» ğŸ‘‡ğŸ» â˜ğŸ» ğŸ‘ğŸ» ğŸ‘ğŸ» âœŠğŸ» ğŸ‘ŠğŸ» ğŸ¤›ğŸ» ğŸ¤œğŸ» ğŸ‘ğŸ» ğŸ™ŒğŸ» ğŸ‘ğŸ» ğŸ¤²ğŸ» ğŸ™ğŸ» âœğŸ» ğŸ’…ğŸ» ğŸ¤³ğŸ» ğŸ’ªğŸ» ğŸ¦µğŸ» ğŸ¦¶ğŸ» ğŸ‘‚ğŸ» ğŸ¦»ğŸ» ğŸ‘ƒğŸ» ğŸ‘¶ğŸ» ğŸ§’ğŸ» ğŸ‘¦ğŸ» ğŸ‘§ğŸ» ğŸ§‘ğŸ» ğŸ‘¨ğŸ» ğŸ‘©ğŸ» ğŸ§‘ğŸ»â€ğŸ¦± ğŸ‘¨ğŸ»â€ğŸ¦± ğŸ‘©ğŸ»â€ğŸ¦± ğŸ§‘ğŸ»â€ğŸ¦° ğŸ‘¨ğŸ»â€ğŸ¦° ğŸ‘©ğŸ»â€ğŸ¦° ğŸ‘±ğŸ» ğŸ‘±ğŸ»â€â™‚ï¸ ğŸ‘±ğŸ»â€â™€ï¸ ğŸ§‘ğŸ»â€ğŸ¦³ ğŸ‘©ğŸ»â€ğŸ¦³ ğŸ‘¨ğŸ»â€ğŸ¦³ ğŸ§‘ğŸ»â€ğŸ¦² ğŸ‘¨ğŸ»â€ğŸ¦² ğŸ‘©ğŸ»â€ğŸ¦² ğŸ§”ğŸ» ğŸ§“ğŸ» ğŸ‘´ğŸ» ğŸ‘µğŸ» ğŸ™ğŸ» ğŸ™ğŸ»â€â™‚ï¸ ğŸ™ğŸ»â€â™€ï¸ ğŸ™ğŸ» ğŸ™ğŸ»â€â™‚ï¸ ğŸ™ğŸ»â€â™€ï¸ ğŸ™…ğŸ» ğŸ™…ğŸ»â€â™‚ï¸ ğŸ™…ğŸ»â€â™€ï¸ ğŸ™†ğŸ» ğŸ™†ğŸ»â€â™‚ï¸ ğŸ™†ğŸ»â€â™€ï¸ ğŸ’ğŸ» ğŸ’ğŸ»â€â™‚ï¸ ğŸ’ğŸ»â€â™€ï¸ ğŸ™‹ğŸ» ğŸ™‹ğŸ»â€â™‚ï¸ ğŸ™‹ğŸ»â€â™€ï¸ ğŸ§ğŸ» ğŸ§ğŸ»â€â™‚ï¸ ğŸ§ğŸ»â€â™€ï¸ ğŸ™‡ğŸ» ğŸ™‡ğŸ»â€â™‚ï¸ ğŸ™‡ğŸ»â€â™€ï¸ ğŸ¤¦ğŸ» ğŸ¤¦ğŸ»â€â™‚ï¸ ğŸ¤¦ğŸ»â€â™€ï¸ ğŸ¤·ğŸ» ğŸ¤·ğŸ»â€â™‚ï¸ ğŸ¤·ğŸ»â€â™€ï¸ ğŸ§‘ğŸ»â€âš•ï¸ ğŸ‘¨ğŸ»â€âš•ï¸ ğŸ‘©ğŸ»â€âš•ï¸ ğŸ§‘ğŸ»â€ğŸ“ ğŸ‘¨ğŸ»â€ğŸ“ ğŸ‘©ğŸ»â€ğŸ“ ğŸ§‘ğŸ»â€ğŸ« ğŸ‘¨ğŸ»â€ğŸ« ğŸ‘©ğŸ»â€ğŸ« ğŸ§‘ğŸ»â€âš–ï¸ ğŸ‘¨ğŸ»â€âš–ï¸ ğŸ‘©ğŸ»â€âš–ï¸ ğŸ§‘ğŸ»â€ğŸŒ¾ ğŸ‘¨ğŸ»â€ğŸŒ¾ ğŸ‘©ğŸ»â€ğŸŒ¾ ğŸ§‘ğŸ»â€ğŸ³ ğŸ‘¨ğŸ»â€ğŸ³ ğŸ‘©ğŸ»â€ğŸ³ ğŸ§‘ğŸ»â€ğŸ”§ ğŸ‘¨ğŸ»â€ğŸ”§ ğŸ‘©ğŸ»â€ğŸ”§ ğŸ§‘ğŸ»â€ğŸ­ ğŸ‘¨ğŸ»â€ğŸ­ ğŸ‘©ğŸ»â€ğŸ­ ğŸ§‘ğŸ»â€ğŸ’¼ ğŸ‘¨ğŸ»â€ğŸ’¼ ğŸ‘©ğŸ»â€ğŸ’¼ ğŸ§‘ğŸ»â€ğŸ”¬ ğŸ‘¨ğŸ»â€ğŸ”¬ ğŸ‘©ğŸ»â€ğŸ”¬ ğŸ§‘ğŸ»â€ğŸ’» ğŸ‘¨ğŸ»â€ğŸ’» ğŸ‘©ğŸ»â€ğŸ’» ğŸ§‘ğŸ»â€ğŸ¤ ğŸ‘¨ğŸ»â€ğŸ¤ ğŸ‘©ğŸ»â€ğŸ¤ ğŸ§‘ğŸ»â€ğŸ¨ ğŸ‘¨ğŸ»â€ğŸ¨ ğŸ‘©ğŸ»â€ğŸ¨ ğŸ§‘ğŸ»â€âœˆï¸ ğŸ‘¨ğŸ»â€âœˆï¸ ğŸ‘©ğŸ»â€âœˆï¸ ğŸ§‘ğŸ»â€ğŸš€ ğŸ‘¨ğŸ»â€ğŸš€ ğŸ‘©ğŸ»â€ğŸš€ ğŸ§‘ğŸ»â€ğŸš’ ğŸ‘¨ğŸ»â€ğŸš’ ğŸ‘©ğŸ»â€ğŸš’ ğŸ‘®ğŸ» ğŸ‘®ğŸ»â€â™‚ï¸ ğŸ‘®ğŸ»â€â™€ï¸ ğŸ•µğŸ» ğŸ•µğŸ»â€â™‚ï¸ ğŸ•µğŸ»â€â™€ï¸ ğŸ’‚ğŸ» ğŸ’‚ğŸ»â€â™‚ï¸ ğŸ’‚ğŸ»â€â™€ï¸ ğŸ‘·ğŸ» ğŸ‘·ğŸ»â€â™‚ï¸ ğŸ‘·ğŸ»â€â™€ï¸ ğŸ¤´ğŸ» ğŸ‘¸ğŸ» ğŸ‘³ğŸ» ğŸ‘³ğŸ»â€â™‚ï¸ ğŸ‘³ğŸ»â€â™€ï¸ ğŸ‘²ğŸ» ğŸ§•ğŸ» ğŸ¤µğŸ» ğŸ‘°ğŸ» ğŸ¤°ğŸ» ğŸ¤±ğŸ» ğŸ‘¼ğŸ» ğŸ…ğŸ» ğŸ¤¶ğŸ» ğŸ¦¸ğŸ» ğŸ¦¸ğŸ»â€â™‚ï¸ ğŸ¦¸ğŸ»â€â™€ï¸ ğŸ¦¹ğŸ» ğŸ¦¹ğŸ»â€â™‚ï¸ ğŸ¦¹ğŸ»â€â™€ï¸ ğŸ§™ğŸ» ğŸ§™ğŸ»â€â™‚ï¸ ğŸ§™ğŸ»â€â™€ï¸ ğŸ§šğŸ» ğŸ§šğŸ»â€â™‚ï¸ ğŸ§šğŸ»â€â™€ï¸ ğŸ§›ğŸ» ğŸ§›ğŸ»â€â™‚ï¸ ğŸ§›ğŸ»â€â™€ï¸ ğŸ§œğŸ» ğŸ§œğŸ»â€â™‚ï¸ ğŸ§œğŸ»â€â™€ï¸ ğŸ§ğŸ» ğŸ§ğŸ»â€â™‚ï¸ ğŸ§ğŸ»â€â™€ï¸ ğŸ’†ğŸ» ğŸ’†ğŸ»â€â™‚ï¸ ğŸ’†ğŸ»â€â™€ï¸ ğŸ’‡ğŸ» ğŸ’‡ğŸ»â€â™‚ï¸ ğŸ’‡ğŸ»â€â™€ï¸ ğŸš¶ğŸ» ğŸš¶ğŸ»â€â™‚ï¸ ğŸš¶ğŸ»â€â™€ï¸ ğŸ§ğŸ» ğŸ§ğŸ»â€â™‚ï¸ ğŸ§ğŸ»â€â™€ï¸ ğŸ§ğŸ» ğŸ§ğŸ»â€â™‚ï¸ ğŸ§ğŸ»â€â™€ï¸ ğŸ§‘ğŸ»â€ğŸ¦¯ ğŸ‘¨ğŸ»â€ğŸ¦¯ ğŸ‘©ğŸ»â€ğŸ¦¯ ğŸ§‘ğŸ»â€ğŸ¦¼ ğŸ‘¨ğŸ»â€ğŸ¦¼ ğŸ‘©ğŸ»â€ğŸ¦¼ ğŸ§‘ğŸ»â€ğŸ¦½ ğŸ‘¨ğŸ»â€ğŸ¦½ ğŸ‘©ğŸ»â€ğŸ¦½ ğŸƒğŸ» ğŸƒğŸ»â€â™‚ï¸ ğŸƒğŸ»â€â™€ï¸ ğŸ’ƒğŸ» ğŸ•ºğŸ» ğŸ•´ğŸ» ğŸ§–ğŸ» ğŸ§–ğŸ»â€â™‚ï¸ ğŸ§–ğŸ»â€â™€ï¸ ğŸ§—ğŸ» ğŸ§—ğŸ»â€â™‚ï¸ ğŸ§—ğŸ»â€â™€ï¸ ğŸ‡ğŸ» ğŸ‚ğŸ» ğŸŒğŸ» ğŸŒğŸ»â€â™‚ï¸ ğŸŒğŸ»â€â™€ï¸ ğŸ„ğŸ» ğŸ„ğŸ»â€â™‚ï¸ ğŸ„ğŸ»â€â™€ï¸ ğŸš£ğŸ» ğŸš£ğŸ»â€â™‚ï¸ ğŸš£ğŸ»â€â™€ï¸ ğŸŠğŸ» ğŸŠğŸ»â€â™‚ï¸ ğŸŠğŸ»â€â™€ï¸ â›¹ğŸ» â›¹ğŸ»â€â™‚ï¸ â›¹ğŸ»â€â™€ï¸ ğŸ‹ğŸ» ğŸ‹ğŸ»â€â™‚ï¸ ğŸ‹ğŸ»â€â™€ï¸ ğŸš´ğŸ» ğŸš´ğŸ»â€â™‚ï¸ ğŸš´ğŸ»â€â™€ï¸ ğŸšµğŸ» ğŸšµğŸ»â€â™‚ï¸ ğŸšµğŸ»â€â™€ï¸ ğŸ¤¸ğŸ» ğŸ¤¸ğŸ»â€â™‚ï¸ ğŸ¤¸ğŸ»â€â™€ï¸ ğŸ¤½ğŸ» ğŸ¤½ğŸ»â€â™‚ï¸ ğŸ¤½ğŸ»â€â™€ï¸ ğŸ¤¾ğŸ» ğŸ¤¾ğŸ»â€â™‚ï¸ ğŸ¤¾ğŸ»â€â™€ï¸ ğŸ¤¹ğŸ» ğŸ¤¹ğŸ»â€â™‚ï¸ ğŸ¤¹ğŸ»â€â™€ï¸ ğŸ§˜ğŸ» ğŸ§˜ğŸ»â€â™‚ï¸ ğŸ§˜ğŸ»â€â™€ï¸ ğŸ›€ğŸ» ğŸ›ŒğŸ» ğŸ§‘ğŸ»â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ‘¬ğŸ» ğŸ‘­ğŸ» ğŸ‘«ğŸ»
  
  b-loading(:active="$fetchState.pending")

  DebugBox
    p $route.query: {{$route.query}}
    p g_current_user: {{g_current_user && g_current_user.id}}

  b-sidebar.is-unselectable.SwarsBattleIndex-Sidebar(fullheight right v-model="sidebar_p" v-if="config")
    .mx-4.my-4
      //- .MySidebarMenuIconWithTitle
      //-   b-icon.is_clickable(icon="menu" @click.native="sidebar_p = false")
      //-   .my_title.has-text-centered
      //-     nuxt-link.has-text-weight-bold.has-text-dark(:to="{name: 'index'}") SHOGI-EXTEND

      b-menu
        b-menu-list(label="Action")
          b-menu-item(tag="nuxt-link" :to="{name: 'swars-users-key', params: {key: config.current_swars_user_key}}" @click.native="sound_play('click')" icon="account" label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±" :disabled="!config.current_swars_user_key")

        b-menu-list(label="è¡¨ç¤ºå½¢å¼")
          b-menu-item(@click.stop="display_key_set('table')")
            template(slot="label")
              span(:class="{'has-text-weight-bold': display_key === 'table'}") ãƒ†ãƒ¼ãƒ–ãƒ«
              b-dropdown.is-pulled-right(position="is-bottom-left" :close-on-click="false" :mobile-modal="false" @active-change="false && sound_play('click')")
                b-icon(icon="dots-vertical" slot="trigger")
                template(v-for="(e, key) in config.table_columns_hash")
                  b-dropdown-item.px-4(@click.native.stop="cb_toggle_handle(e)" :key="key")
                    span(:class="{'has-text-grey': !visible_hash[key], 'has-text-weight-bold': visible_hash[key]}") {{e.label}}
          b-menu-item(label="é–‹æˆ¦" @click.stop="display_key_set('critical')" :class="{'has-text-weight-bold': display_key === 'critical'}")
          b-menu-item(label="ä¸­ç›¤" @click.stop="display_key_set('outbreak')" :class="{'has-text-weight-bold': display_key === 'outbreak'}")
          b-menu-item(label="çµ‚å±€" @click.stop="display_key_set('last')"     :class="{'has-text-weight-bold': display_key === 'last'}")

        b-menu-list(label="è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³")
          b-menu-item(@click="sound_play('click')")
            template(slot="label" slot-scope="props")
              | è¡¨ç¤ºä»¶æ•°
              b-icon.is-pulled-right(:icon="props.expanded ? 'menu-up' : 'menu-down'")
            template(v-for="per in config.per_page_list")
              b-menu-item(:label="`${per}`" @click.stop="per_change_handle(per)" :class="{'has-text-weight-bold': per === config.per}")

          b-menu-item(@click="sound_play('click')")
            template(slot="label" slot-scope="props")
              | ãƒ•ã‚£ãƒ«ã‚¿
              b-icon.is-pulled-right(:icon="props.expanded ? 'menu-up' : 'menu-down'")
            //- b-menu-item(label="å‹ã¡" @click.stop="filter_research(`judge:win`)"  :class="{'has-text-weight-bold': filter_match_p('judge:win')}")
            //- b-menu-item(label="è² ã‘" @click.stop="filter_research(`judge:lose`)" :class="{'has-text-weight-bold': filter_match_p('judge:lose')}")
            //- b-menu-item(label="ãªã—" @click.stop="filter_research(``)"           :class="{'has-text-weight-bold': !filter_match_p('judge:')}")
            b-menu-item(label="å‹ã¡" tag="nuxt-link" :to="{name: 'swars-search', query: {query: `${config.current_swars_user_key} judge:win`}}"  @click.native="sound_play('click')" :class="{'has-text-weight-bold': filter_match_p('judge:win')}")
            b-menu-item(label="è² ã‘" tag="nuxt-link" :to="{name: 'swars-search', query: {query: `${config.current_swars_user_key} judge:lose`}}" @click.native="sound_play('click')" :class="{'has-text-weight-bold': filter_match_p('judge:lose')}")
            b-menu-item(label="ãªã—" tag="nuxt-link" :to="{name: 'swars-search', query: {query: `${config.current_swars_user_key}`}}"            @click.native="sound_play('click')" :class="{'has-text-weight-bold': !filter_match_p('judge:')}")

        b-menu-list(label="ä¸€æ‹¬å–å¾—")
          b-menu-item(
            label="å¤ã„æ£‹è­œã‚’å–å¾—"
            @click.native="config.current_swars_user_key && sound_play('click')"
            tag="nuxt-link"
            :to="{name: 'swars-users-key-download-all', params: {key: config.current_swars_user_key}}"
            :disabled="!config.current_swars_user_key")

          b-menu-item(:disabled="!config.current_swars_user_key" @click="sound_play('click')")
            template(slot="label" slot-scope="props")
              | ç›´è¿‘30ä»¶ ï¾€ï¾ï½³ï¾ï¾›ï½°ï¾„ï¾
              b-icon.is-pulled-right(:icon="props.expanded ? 'menu-up' : 'menu-down'")
            template(v-for="e in ZipKifuInfo.values")
              b-menu-item(@click="zip_dl_handle(e.key)" :label="e.name")

        b-menu-list(label="ä¾¿åˆ©ãªä½¿ã„æ–¹ã‚ã‚Œã“ã‚Œ")
          b-menu-item(
            label="æ¤œç´¢åˆæœŸå€¤è¨­å®š"
            @click.native="config.current_swars_user_key && sound_play('click')"
            tag="nuxt-link"
            :to="{name: 'swars-users-key-default-key', params: {key: config.current_swars_user_key}}"
            :disabled="!config.current_swars_user_key")

          b-menu-item(label="ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹" @click="bookmark_desc" :disabled="!config.current_swars_user_key")

          b-menu-item(:disabled="!config.current_swars_user_key" @click="sound_play('click')")
            template(slot="label" slot-scope="props")
              | å¤–éƒ¨APP ï½¼ï½®ï½°ï¾„ï½¶ï½¯ï¾„
              b-icon.is-pulled-right(:icon="props.expanded ? 'menu-up' : 'menu-down'")
            template(v-for="e in ExternalAppInfo.values")
              b-menu-item(@click="external_app_handle(e)" :label="e.name")

          b-menu-item(
            label="KENTO API"
            @click.native="config.current_swars_user_key && sound_play('click')"
            tag="nuxt-link"
            :to="{name: 'swars-users-key-kento-api', params: {key: config.current_swars_user_key}}"
            :disabled="!config.current_swars_user_key")

        b-menu-list(label="test" v-if="development_p")
          b-menu-item
            template(slot="label")
              | Devices
              b-dropdown.is-pulled-right(position="is-bottom-left")
                b-icon(icon="dots-vertical" slot="trigger")
                b-dropdown-item Action
                b-dropdown-item Action
                b-dropdown-item Action

        b-menu-list(label="DEBUG" v-if="development_p")
          b-menu-item(label="æ£‹è­œã®ä¸æ•´åˆ"     @click="$router.push({query: {query: 'Yamada_Taro', error_capture_test: true, force: true}})")
          b-menu-item(label="æ£‹è­œã®å†å–å¾—"     @click="$router.push({query: {query: 'Yamada_Taro', destroy_all: true, force: true}})")
          b-menu-item(label="æ£‹è­œã®æ™®é€šã«å–å¾—" @click="$router.push({query: {query: 'Yamada_Taro'}})")
          b-menu-item(label="å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰è¡¨ç¤º"   @click="$router.push({query: {query: '', all: 'true', per: 50, debug: 'true'}})")

  MainNavbar(wrapper-class="container is-fluid")
    template(slot="brand")
      NavbarItemHome
      b-navbar-item(tag="nuxt-link" :to="{}" @click.native="reset_handle")
        h1.has-text-weight-bold å°†æ£‹ã‚¦ã‚©ãƒ¼ã‚ºæ£‹è­œæ¤œç´¢
    template(slot="end")
      NavbarItemLogin
      NavbarItemProfileLink
      b-navbar-item(@click="sidebar_toggle")
        b-icon(icon="menu")

  MainSection
    .container.is-fluid
      .columns
        .column
          b-field
            b-autocomplete(
              size="is-medium"
              v-model.trim="query"
              :data="search_form_complete_list"
              type="search"
              placeholder="ã‚¦ã‚©ãƒ¼ã‚ºIDã‚’å…¥åŠ›"
              open-on-focus
              expanded
              @focus="query = ''"
              @select="search_select_handle"
              @keydown.native.enter="search_enter_handle"
              ref="main_search_form"
              )
            p.control
              b-button.search_form_submit_button(@click="search_click_handle" icon-left="magnify" size="is-medium" :loading="$fetchState.pending && false" :disabled="!query")

          .columns.is-multiline.mt-4(v-if="board_show_p")
            template(v-for="e in config.records")
              // https://bulma.io/documentation/columns/responsiveness/
              // widescreen 1/5 (is-one-fifth-widescreen)
              // desktop    1/4 (is-one-quarter-desktop)
              // table      1/4 (is-one-quarter-tablet)
              .column.is-one-fifth-widescreen.is-one-quarter-desktop.is-one-third-tablet.has-text-centered.px-0
                SwarsBattleIndexMembershipUserLinkTo.is_line_break_on.is-size-7(:membership="e.memberships[1]")
                a(@click="show_handle(e)")
                  MyShogiPlayer(
                    :run_mode="'view_mode'"
                    :debug_mode="false"
                    :start_turn="sp_start_turn(e)"
                    :kifu_body="e.sfen_body"
                    :theme="'simple'"
                    :size="'x-small'"
                    :sound_effect="false"
                    :vlayout="true"
                    :setting_button_show="false"
                    :summary_show="false"
                    :operation_disable="true"
                    :overlay_navi="false"
                    :flip="e.flip"
                  )
                // :hidden_if_piece_stand_blank="display_key === 'critical'"
                SwarsBattleIndexMembershipUserLinkTo.is_line_break_on.is-size-7(:membership="e.memberships[0]")

          //- v-if="$route.query.query || config.records.length >= 1"
          template(v-if="display_key === 'table'")
            b-table(
              v-if="$route.query.query || config.records.length >= 1"

              :total        = "config.total"
              :current-page = "config.page"
              :per-page     = "config.per"

              :show-header  = "config.total >= 1 || true"
              :paginated    = "config.total >= 1 || true"

              backend-pagination
              pagination-simple
              :data="config.records"
              @page-change="(page) => page_change_or_sort_handle({page})"

              backend-sorting
              :default-sort-direction="config.sort_order_default"
              :default-sort="[config.sort_column, config.sort_order]"
              @sort="(sort_column, sort_order) => page_change_or_sort_handle({sort_column, sort_order})"

              ref="table"

              :row-class="row_class"

              )

              SwarsBattleIndexTableEmpty(slot="empty" v-if="!$fetchState.pending && $route.query.query && config.total === 0")

              b-table-column(v-slot="{row}" field="id" :label="config.table_columns_hash['id'].label" :visible="visible_hash.id" sortable numeric v-if="config.table_columns_hash.id")
                a(@click="show_handle(row)") \#{{row.id}}

              template(v-if="config.current_swars_user_key")
                b-table-column(v-slot="{row}" label="è‡ªåˆ†")
                  SwarsBattleIndexMembership(:base="base" :membership="row.memberships[0]")
                b-table-column(v-slot="{row}" label="ç›¸æ‰‹")
                  SwarsBattleIndexMembership(:base="base" :membership="row.memberships[1]")
              template(v-else)
                b-table-column(v-slot="{row}" label="å‹ã¡")
                  SwarsBattleIndexMembership(:base="base" :membership="row.memberships[0]")
                b-table-column(v-slot="{row}" label="è² ã‘")
                  SwarsBattleIndexMembership(:base="base" :membership="row.memberships[1]")

              b-table-column(v-slot="{row}" field="final_key" :label="config.table_columns_hash.final_info.label" :visible="visible_hash.final_info" sortable)
                span(:class="row.final_info.class")
                  | {{row.final_info.name}}

              b-table-column(v-slot="{row}" field="turn_max" :label="config.table_columns_hash.turn_max.label" :visible="visible_hash.turn_max" sortable numeric)
                | {{row.turn_max}}

              b-table-column(v-slot="{row}" field="critical_turn" :label="config.table_columns_hash.critical_turn.label" :visible="visible_hash.critical_turn" sortable numeric v-if="config.table_columns_hash.critical_turn")
                | {{row.critical_turn}}

              b-table-column(v-slot="{row}" field="outbreak_turn" :label="config.table_columns_hash.outbreak_turn.label" :visible="visible_hash.outbreak_turn" sortable numeric v-if="config.table_columns_hash.outbreak_turn")
                | {{row.outbreak_turn}}

              b-table-column(v-slot="{row}" field="grade_diff" :label="config.table_columns_hash.grade_diff.label" :visible="visible_hash.grade_diff" sortable numeric v-if="config.table_columns_hash.grade_diff")
                | {{row.grade_diff}}

              b-table-column(v-slot="{row}" field="rule_key" :label="config.table_columns_hash.rule_info.label" :visible="visible_hash.rule_info" sortable)
                | {{row.rule_info.name}}

              b-table-column(v-slot="{row}" field="preset_key" :label="config.table_columns_hash.preset_info.label" :visible="visible_hash.preset_info" sortable)
                | {{row.preset_info.name}}

              b-table-column(v-slot="{row}" field="battled_at" :label="config.table_columns_hash.battled_at.label" :visible="visible_hash.battled_at" sortable)
                | {{row_time_format(row.battled_at)}}

              b-table-column(v-slot="{row}")
                .buttons.are-small
                  PiyoShogiButton(type="button" :href="piyo_shogi_app_with_params_url(row)")
                  KentoButton(tag="a" :href="kento_app_with_params_url(row)")
                  KifCopyButton(@click="kifu_copy_handle(row)")
                  b-button(tag="nuxt-link" :to="{name: 'swars-battles-key', params: {key: row.key}}" @click.native="sound_play('click')") è©³ç´°

    client-only
      DebugPre {{config}}
      DebugPre {{$store.user}}
</template>

<script>
import _ from "lodash"

import { support } from "./support.js"

import { MyLocalStorage } from "@/components/models/MyLocalStorage.js"
import { ExternalAppInfo } from "@/components/models/ExternalAppInfo.js"

import SwarsBattleIndexCore from "./SwarsBattleIndexCore.js"
//- import SwarsBattleIndexHistory from "./SwarsBattleIndexHistory.js"

import MemoryRecord from 'js-memory-record'

class ZipKifuInfo extends MemoryRecord {
}
ZipKifuInfo.memory_record_reset([])

export default {
  name: "SwarsBattleIndex",
  mixins: [
    support,
    SwarsBattleIndexCore,
  ],

  data() {
    return {
      sidebar_p: false,
      config: {},
    }
  },

  // watchQuery: ['query'],
  watch: {
    "$route.query": "$fetch",
  },

  mounted() {
    if (false) {
      this.desktop_focus_to(this.$refs.main_search_form)
    }
  },

  fetchOnServer: false,
  fetch() {
    // if (!this.$route.query.query) {
    //   this.$router.push({name: "swars-search", query: {query: "user1"}})
    // }

    let query = {...this.$route.query}
    if (!query.query) {
      query.query = MyLocalStorage.get("swars_search_default_key")
    }

    return this.$axios.$get("/w.json", {params: query}).then(config => {
      this.config = config

      // if (this.display_key == null) {
      //   this.display_key  = this.config.display_key // ä½•ã®å±€é¢ã®è¡¨ç¤ºã‚’ã™ã‚‹ã‹ï¼Ÿ
      // }

      // ãªã‹ã‹ã‚‰ nuxt-link ã—ãŸã¨ã $fetch ãŒå‘¼ã°ã‚Œã‚‹ãŒã€
      // this.query ã¯å‰ã®çŠ¶æ…‹ãªã®ã§æ›´æ–°ã™ã‚‹
      this.query = this.config.query
      // this.query = this.$route.query.query

      this.ls_setup() // config ã‹ã‚‰ visible_hash ã‚„ display_key ã‚’è¨­å®š

      ZipKifuInfo.memory_record_reset(this.config.zip_kifu_info)

      this.notice_collector_run(this.config)
    })
  },

  methods: {
    reset_handle() {
      // this.query = ""
      // this.config.records = []
    },

    bookmark_desc() {
      this.sidebar_p = false
      this.sound_play("click")
      this.$buefy.dialog.alert({
        title: "ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹",
        message: "<b>æ¤œç´¢ç›´å¾Œ</b>ã®ãƒšãƒ¼ã‚¸ã‚’<b>ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </b>ã‹ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã—ã¦ãŠãã¨æ¬¡ã‹ã‚‰ã‚¦ã‚©ãƒ¼ã‚ºIDã‚’å…¥åŠ›ã™ã‚‹æ‰‹é–“ã‚’çœã‘ã¾ã™",
        canCancel: ["outside", "escape"],
        confirmText: "ã‚ã‹ã£ãŸ",
        type: 'is-info',
        onConfirm: () => this.sound_play("click"),
        onCancel:  () => this.sound_play("click"),
      })
    },

    ////////////////////////////////////////////////////////////////////////////////

    // æ¤œç´¢ã™ã¹ã¦ã“ã“ã§å‡¦ç†ã™ã‚‹
    interactive_search(params) { // private
      this.sound_play("click")
      if (this.$fetchState.pending) {
        this.toast_ng("é€£æ‰“ã™ã‚“ãª")
        return
      }
      const new_params = {...this.$route.query, ...params} // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã©ã§ã¯ query ã‚’ä¸Šæ›¸ãã™ã‚‹ã€‚ã¾ãŸã¯ãªã«ã‚‚ã—ãªã„ã€‚
      if (Number(new_params.page || 0) <= 1) {
        delete new_params.page
      }
      this.clog("new_params", new_params)
      // https://github.com/vuejs/vue-router/issues/2872
      this.$router.push({query: new_params}, () => {
        this.clog("query ã«å¤‰åŒ–ãŒã‚ã£ãŸã®ã§ watch çµŒç”±ã§ $fetch ãŒå‘¼ã°ã‚Œã‚‹")
      }, () => {
        this.clog("query ã«å¤‰åŒ–ãŒãªã„ã®ã§ watch çµŒç”±ã§ $fetch ãŒå‘¼ã°ã‚Œãªã„ã€‚ã®ã§è‡ªåˆ†ã§å‘¼ã¶")
        this.$fetch()
      })
      // $router.push ã®ç›´å¾Œã« $fetch ã‚’å‘¼ã¶ã¨ nuxt.js ã®ä¸å…·åˆã‹ã‚ã‹ã‚‰ã‚“ã‘ã©ã€
      // $route.query ãŒæ›´æ–°å‰ã®å€¤ã®ã¾ã¾ãªã®ã§ã€æ¤œç´¢çµæœãŒç•°ãªã£ã¦ã—ã¾ã† ($nextTickã‚‚æ„å‘³ãªã—)
      // ãªã®ã§ watch ã«ã¾ã‹ã›ã¦ã„ã‚‹
    },

    // b-table ã® @sort ã¨ @page-change ã«åå¿œ
    page_change_or_sort_handle(params) {
      this.$router.push({query: {...this.$route.query, ...params}}, () => {
        this.sound_play("click")
      })
    },

    // 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°ã®å¤‰æ›´
    per_change_handle(per) {
      this.page_change_or_sort_handle({per})
    },

    // ã“ã“ã ã‘ç‰¹åˆ¥ã§ this.query ã§ä¸Šæ›¸ãã—ã¦ã„ã‚‹
    // ãªãœãªã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ query ã«åŸ‹ã‚è¾¼ã¾ãªã„ã¨ã„ã‘ãªã„ã‹ã‚‰
    filter_research(query) {
      alert("æœªä½¿ç”¨")

      if (!this.config.current_swars_user_key) {
        this.toast_warn("å…ˆã«èª°ã‹ã§æ¤œç´¢ã—ã¦ãã ã•ã„")
        return
      }
      const new_query = _.trim(`${this.config.current_swars_user_key} ${query}`)

      // ã“ã“ã§è¨­å®šã—ã¦ãŠãã¨æ¤œç´¢å‰ã«å¤‰æ›´ã•ã‚Œã‚‹ã€‚ã‘ã©ãªãã¦ã‚‚ã„ã€‚æ„å‘³ã‚ã‚‹ã‹ãªï¼Ÿ
      this.query = new_query

      this.interactive_search({query: new_query})
    },

    filter_match_p(str) {
      const query = this.$route.query.query
      if (query) {
        return query.includes(str)
      }
    },

    ////////////////////////////////////////////////////////////////////////////////

    external_app_handle(info) {
      if (this.config.current_swars_user_key) {
        this.sound_play("click")
        MyLocalStorage.set("external_app_setup", true)
        this.$router.push({
          name: 'swars-users-key-direct-open-external_app_key',
          params: {
            key: this.config.current_swars_user_key,
            external_app_key: info.key,
          },
        })
      }
    },

    zip_dl_handle(key) {
      this.sound_play("click")
      const params = {
        ...this.$route.query,
        zip_kifu_key: key,
      }
      const usp = new URLSearchParams()
      _.each(params, (v, k) => usp.set(k, v))
      const url = this.$config.MY_SITE_URL + `/w.zip?${usp}`
      location.href = url
    },

    cb_toggle_handle(column) {
      this.sound_play('click')
      this.$set(this.visible_hash, column.key, !this.visible_hash[column.key])
    },

    row_class(row, index) {
      if (row.judge) {
        return `is-${row.judge.key}` // is- ã§å§‹ã‚ã‚‹ã¨ mobile-cards ã«ãªã£ãŸã¨ãæ¶ˆã•ã‚Œãªããªã‚‹
      }
    },

    sidebar_toggle() {
      this.sound_play('click')
      this.sidebar_p = !this.sidebar_p
    },

    display_key_set(key) {
      if (this.display_key != key) {
        this.sound_play('click')
        this.display_key = key
      }
    },

    kifu_copy_handle(row) {
      this.sound_play('click')
      this.kif_clipboard_copy({kc_path: row.show_path})
    },
  },

  computed: {
    board_show_p() {
      return ["critical", "outbreak", "last"].includes(this.display_key)
    },

    search_form_complete_list() {
      if (this.config.remember_swars_user_keys) {
        return this.config.remember_swars_user_keys.filter((option) => {
          return option.toString().toLowerCase().indexOf((this.query || "").toLowerCase()) >= 0
        })
      }
    },

    base()            { return this            },
    ExternalAppInfo() { return ExternalAppInfo },
    ZipKifuInfo()     { return ZipKifuInfo     },
  },
}
</script>

<style lang="sass">
.SwarsBattleIndex-Sidebar
  .menu-label:not(:first-child)
    margin-top: 2em

.SwarsBattleIndex
  .container
    +mobile
      padding-left: 0 ! important
      padding-right: 0 ! important

  .b-table
    margin-top: 1.5rem
    +mobile
      margin-top: 1rem
</style>
