<template lang="pug">
client-only
  .SwarsBattleShowApp
    FetchStateErrorMessage(:fetchState="$fetchState")
    b-loading(:active="$fetchState.pending")

    .MainContainer(v-if="record")
      SwarsBattleShowSidebar(:base="base")
      SwarsBattleShowNavbar(:base="base")

      .FirstView.is-unselectable
        .CustomShogiPlayerWrap
          CustomShogiPlayer(
            sp_layer="is_layer_off"
            sp_layout="is_horizontal"
            sp_fullheight="is_fullheight_off"
            :sp_run_mode.sync="sp_run_mode"
            :sp_turn="sp_turn"
            :sp_body="record.sfen_body"
            :sp_key_event_capture_enabled="true"
            sp_slider="is_slider_on"
            sp_controller="is_controller_on"
            :sp_viewpoint.sync="viewpoint"
            :sp_player_info="player_info"
            @update:sp_turn="real_turn_set"
            @update:short_sfen="v => short_sfen = v"
            ref="main_sp"
          )

      SwarsBattleShowTimeChart(
        v-if="time_chart_params"
        @update:turn="turn_set_from_chart"
        :chart_turn="current_turn"
        ref="SwarsBattleShowTimeChart"
      )

      .app_buttons_container
        .buttons.is-centered
          PiyoShogiButton(:href="current_kifu_vo.piyo_url" @click="$sound.play_click()")
          KentoButton(tag="a" :href="current_kifu_vo.kento_url" @click="$sound.play_click()")
          KifCopyButton(@click="kifu_copy_button_handle")
        .buttons.is-centered(v-if="false")
          b-button(@click="back_handle" icon-left="chevron-left" size="is-small")
          TweetButton(:body="permalink_url" @after_click="$sound.play_click()")
          b-button(icon-left="menu" @click="sidebar_toggle" size="is-small")

      .battle_title_container.has-background-grey-lighter.py-6.battle_title.has-text-grey-dark.is-size-7-mobile
        p
          | {{record.piyo_shogi_base_params.game_name}}
          span.mx-1(v-if="record.preset_info.name !== '平手'") {{record.preset_info.name}}
        p
          SwarsBattleShowUserLink(:membership="record.memberships[0]" :with_location="true" :with_judge="true")
          span.mx-1 vs
          SwarsBattleShowUserLink(:membership="record.memberships[1]" :with_location="true" :with_judge="true")
        p {{record.description}}
        p {{record.turn_max}}手まで (最後は{{record.final_info.name}})

      //-   DebugPre(v-if="development_p")
      //-     | start_turn: {{start_turn}}
      //-     | current_turn: {{current_turn}}
      //-     | record.turn: {{record.turn}}
      //-     | record.display_turn: {{record.display_turn}}
      //-     | record.critical_turn: {{record.critical_turn}}
      //-     | record.outbreak_turn: {{record.outbreak_turn}}
      //-     | record.turn_max: {{record.turn_max}}
      //-     | record.turn: {{record.turn}}
      //-     | viewpoint: {{viewpoint}}
      DebugPre(v-if="development_p") {{record}}
</template>

<script>
import { support_parent  } from "./support_parent.js"
import { app_chore       } from "./app_chore.js"
import { app_chart       } from "./app_chart.js"
import { app_export      } from "./app_export.js"
import { app_sidebar     } from "./app_sidebar.js"
import { app_storage     } from "./app_storage.js"

import { SceneInfo } from "../models/scene_info.js"
import { KifuVo } from "@/components/models/kifu_vo.js"
import { FormatTypeInfo } from "@/components/models/format_type_info.js"
import { SafeSfen } from "@/components/models/safe_sfen.js"
const QueryString = require("query-string")

export default {
  name: "SwarsBattleShowApp",
  mixins: [
    support_parent,
    app_chore,
    app_chart,
    app_export,
    app_sidebar,
    app_storage,
  ],
  data() {
    return {
      record: null,            // 属性がたくさん入ってる

      sp_run_mode: null,       // shogi-player の現在のモード。再生モード(view_mode)と継盤モード(play_mode)を切り替える用
      current_turn: null,      // KENTOに渡すための手番
      viewpoint: null,     // 視点
      short_sfen: null,          // BOD タイプの sfen

      time_chart_p: false,     // 時間チャートを表示する？
      time_chart_params: null, // 時間チャートのデータ
    }
  },
  provide() {
    return {
      TheShow: this,
    }
  },

  // https://router.vuejs.org/ja/guide/advanced/navigation-guards.html#%E3%83%AB%E3%83%BC%E3%83%88%E5%8D%98%E4%BD%8D%E3%82%AC%E3%83%BC%E3%83%89
  // beforeRouteEnter (to, from, next) {
  //   debugger
  //   // このコンポーネントを描画するルートが確立する前に呼ばれます。
  //   // `this` でのこのコンポーネントへのアクセスはできません。
  //   // なぜならばこのガードが呼び出される時にまだ作られていないからです!
  // },

  fetch() {
    // alert("fetch")
    // alert(this.$route.params.key)
    // console.log(this)

    // console.log(this.$route.query)
    // http://localhost:3000/w.json?query=DevUser1&format_type=user
    // http://localhost:4000/swars/users/DevUser1

    // http://localhost:3000/w/DevUser1-YamadaTaro-20200101_123401.json?basic_fetch=1
    // http://localhost:4000/swars/battles/DevUser1-YamadaTaro-20200101_123401
    // const record = await $axios.$get(`/w/${params.key}.json`, {params: {ogp_only: true, basic_fetch: true, ...query}})

    const params = {
      basic_fetch: true,
      // memberships の順序を [black, white] に固定する
      // これを入れないと viewpoint と対象者が設定されなかったとき処理で、勝った方が左になる
      // この挙動は下の表示で確認できる
      viewpoint: "black",
    }

    // 重要なのはこっちなので待つ
    return Promise.all([
      this.$axios.$get(`/w/${this.$route.params.key}.json`, {params: params}).then(e => {
        this.record = e
        this.record_setup()
      }),
      this.$axios.$get(`/w/${this.$route.params.key}.json`, {params: {time_chart_fetch: true}}).then(e => {
        this.time_chart_params = e.time_chart_params
      }),
    ])
  },

  mounted() {
    this.ga_click("バトル詳細")
  },

  // watch: {
  //   current_turn() { this.url_replace() },
  //   viewpoint() { this.url_replace() },
  // },

  methods: {
    tweet_handle() {
      this.$sound.play_click()
      this.tweet_window_popup({text: this.permalink_url})
    },

    current_url_copy() {
      this.sidebar_close()
      this.clipboard_copy({text: this.permalink_url})
    },

    short_url_copy(method) {
      this.sidebar_close()
      this.clipboard_copy({text: this.short_url(method)})
    },

    short_url(method) {
      return this.$config.MY_NUXT_URL + `/swars/battles/${this.record.key}/${method}`
    },

    url_replace() {
      // FIXME: queryだけ変更するとエラーになる
      this.$router.replace({query: {
        ...this.$route.query,
        turn: this.current_turn,
        viewpoint: this.viewpoint,
      }}, () => {}, () => {})
    },

    kifu_copy_button_handle() {
      this.kifu_copy_handle(this.FormatTypeInfo.fetch('kif_utf8'))
    },

    sidebar_toggle() {
      this.$sound.play_click()
      this.sidebar_p = !this.sidebar_p
    },

    back_handle() {
      this.$sound.play_click()
      this.back_to({name: "swars-search"})
    },

    // delete_click_handle() {
    //   // this.$router.go(-1)
    // },

    // バトル情報がセットされたタイミングまたは変更されたタイミング
    record_setup() {
      // 開始手数を保存 (KENTOに渡すためでもある)
      this.current_turn = this.sp_turn

      // 継盤解除
      this.sp_run_mode = "view_mode"

      // 最初の上下反転状態
      this.viewpoint = this.default_viewpoint

      // 指し手がない棋譜の場合は再生モード(view_mode)に意味がないため継盤モード(play_mode)で開始する
      // これは勝手にやらない方がいい？
      if (true) {
        if (this.record.turn_max === 0) {
          this.sp_run_mode = "play_mode"
        }
      }

      this.short_sfen = this.record.sfen_body
    },

    // 「チャート表示→閉じる→別レコード開く」のときに別レコードの時間チャートを開く
    // 本当は SwarsBattleShowTimeChart の中で処理したかった
    // chart_show_auto() {
    //   if (this.time_chart_p) {
    //     this.$nextTick(() => { this.$refs.SwarsBattleShowTimeChart.chart_show() })
    //   }
    // },

    // 開始局面
    // turn sp_turn critical_turn の順に見る
    sp_turn_of(record) {
      this.__assert__(record, "record")

      const turn = this.$route.query.turn
      if (turn != null) {
        return Number(turn)
      }
      if (this.scene_info) {
        return this.scene_info.sp_turn_of(record)
      }
      return record.display_turn
    },

    // SwarsBattleShowTimeChart でチャートをクリックしたときに変更する
    turn_set_from_chart(v) {
      this.$refs.main_sp.sp_object().api_board_turn_set(v) // 直接 shogi-player に設定
      this.current_turn = v                                    // KENTO用に設定 (shogi-playerからイベントが来ないため)
      this.slider_focus()                             // チャートを動かした直後も左右キーが使えるようにする
    },

    // shogi-player の局面が変化したときの手数を取り出す
    real_turn_set(v) {
      this.current_turn = v
    },

    // this.$nextTick(() => this.slider_focus()) の方法だと失敗する
    slider_focus() {
      if (this.$refs.main_sp) {
        this.$refs.main_sp.sp_object().api_turn_slider_focus()
      }
    },

    other_app_click_handle(app_name) {
      this.sidebar_p = false
      this.$sound.play_click()
      this.ga_click(app_name)
      this.remote_notify({emoji: ":外部アプリ:", subject: "将棋ウォーズ棋譜検索→詳細→サイドバー", body: app_name})
    },
  },

  computed: {
    base() { return this },
    FormatTypeInfo() { return FormatTypeInfo },

    SceneInfo()  { return SceneInfo                             },
    scene_info() { return this.SceneInfo.lookup(this.scene_key) },
    scene_key()  { return this.$route.query.scene_key           },

    meta() {
      // ページ遷移で来たとき head は fetch より前にいきなり呼ばれているためガードが必要
      if (!this.record) {
        return
      }
      return {
        title: [this.og_title, "将棋ウォーズ"],
        og_title: this.og_title,
        og_image: this.og_image,
        description: this.record.description,
      }
    },

    default_viewpoint() {
      return this.$route.query.viewpoint || "black"
    },

    color_theme_key() {
      return this.$route.query.color_theme_key || "is_color_theme_real"
    },

    og_image() {
      return QueryString.stringifyUrl({
        url: `${this.record.show_path}.png`,
        query: {
          turn: this.current_turn,
          viewpoint: this.viewpoint,
          color_theme_key: this.color_theme_key,
        },
      })
    },

    og_title() {
      return `${this.record.title} ${this.current_turn}手目`
    },

    sp_turn() {
      return this.sp_turn_of(this.record)
    },

    player_info() {
      return null
      return this.record.player_info
    },

    permalink_url() {
      return QueryString.stringifyUrl({
        url: `${this.$config.MY_SITE_URL}/swars/battles/${this.record.key}`,
        query: { turn: this.current_turn, viewpoint: this.viewpoint },
      })
    },

    current_kifu_vo() {
      return this.$KifuVo.create({
        kif_url: `${this.$config.MY_SITE_URL}${this.record.show_path}.kif`,
        sfen:      this.record.sfen_body,
        turn:      this.current_turn,
        viewpoint: this.viewpoint,
      })
    },

    // tweet_url() {
    //   return this.tweet_url_build_from_text(this.permalink_url)
    // },

    // 共有将棋盤で開くときのパラメータ
    share_board_query() {
      return {
        // 共有将棋盤に転送するときは個人情報をなるべく隠したい意図があるのであえて何も入れない
        //
        // record.title:        対戦者の名前
        // record.description:  戦法のみ
        //
        title: "将棋ウォーズ棋譜",
        xbody:  SafeSfen.encode(this.record.sfen_body),
        turn:  this.current_turn,
        viewpoint: this.viewpoint,
      }
    },

    ////////////////////////////////////////////////////////////////////////////////

    // { black: "alice", white: "bob" }
    player_info_hash() {
      return this.record.memberships.reduce((a, m) => {
        return {
          ...a,
          [m.location_key]: `${m.user.key} ${m.grade_info.name}`,
        }
      }, {})
    },

    style_editor_query() {
      return {
        body: this.record.sfen_body,
        turn: this.current_turn,
        viewpoint: this.viewpoint,
        ...this.player_info_hash,
      }
    }
  },
}
</script>

<style lang="sass">
.SwarsBattleShowApp
  //////////////////////////////////////////////////////////////////////////////// 1ページ目
  .FirstView
    // background-color: hsl(99.5, 40.6, 80.2)
    +tablet
      padding: 3rem 0 0.75rem
    +mobile
      padding: 0.75rem 0 1.5rem // 画像化するときに切り取りやすいように少しあける

  //////////////////////////////////////////////////////////////////////////////// ShogiPlayer
  .CustomShogiPlayerWrap
    display: flex
    justify-content: center
    align-items: center
    flex-direction: column
    // height: 100vh               // app_buttons_container を画面外にする

  .CustomShogiPlayer
    +tablet
      max-width: calc(100vmin * 0.65)
    +desktop
      max-width: calc(100vmin * 0.75)

  //////////////////////////////////////////////////////////////////////////////// ShogiPlayer の下のボタンたち
  .app_buttons_container
    background-color: $white-ter
    margin: 0 0 0
    padding: 3rem 0

  ////////////////////////////////////////////////////////////////////////////////
  .battle_title_container
    line-height: 1.8
    display: flex
    align-items: center
    justify-content: center
    flex-direction: column

.STAGE-development
  .SwarsBattleShowApp
    .column, .FirstView
      border: 1px dashed change_color($primary, $alpha: 0.2)
</style>
